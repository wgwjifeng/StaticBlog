<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="google15310e762694357f.html" />













  
  
  <link href="/StaticBlog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/StaticBlog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/StaticBlog/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Windows,Kernel," />





  <link rel="alternate" href="/StaticBlog/rss2.xml" title="MeeSong's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/StaticBlog/uploads/avatar.jpg?v=5.1.1" />






<meta name="description" content="从概念上来说, 进程是线程的容器, 进程提供了线程必要的地址空间, 上下文环境, 安全凭证等等..而线程是最基本的执行单位和调度单位. 作业呢? 作业可以看作是进程的容器, 使其可以对进程进行统一的管理. 从实际上来说, 内核就是各种各样的数据结构, 进程, 线程和作业也不例外.">
<meta name="keywords" content="Windows,Kernel">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows kernel learning: 5. Process, Thread and Jobs">
<meta property="og:url" content="https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/index.html">
<meta property="og:site_name" content="MeeSong&#39;s Blog">
<meta property="og:description" content="从概念上来说, 进程是线程的容器, 进程提供了线程必要的地址空间, 上下文环境, 安全凭证等等..而线程是最基本的执行单位和调度单位. 作业呢? 作业可以看作是进程的容器, 使其可以对进程进行统一的管理. 从实际上来说, 内核就是各种各样的数据结构, 进程, 线程和作业也不例外.">
<meta property="og:image" content="https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/P-T-Associated.jpg">
<meta property="og:updated_time" content="2017-05-30T02:47:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Windows kernel learning: 5. Process, Thread and Jobs">
<meta name="twitter:description" content="从概念上来说, 进程是线程的容器, 进程提供了线程必要的地址空间, 上下文环境, 安全凭证等等..而线程是最基本的执行单位和调度单位. 作业呢? 作业可以看作是进程的容器, 使其可以对进程进行统一的管理. 从实际上来说, 内核就是各种各样的数据结构, 进程, 线程和作业也不例外.">
<meta name="twitter:image" content="https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/P-T-Associated.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/StaticBlog/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/"/>





  <title>Windows kernel learning: 5. Process, Thread and Jobs | MeeSong's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-80255644-1', 'auto');
  ga('send', 'pageview');
</script>











  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/StaticBlog/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">MeeSong's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">探索有趣的事物~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/StaticBlog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/StaticBlog/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/StaticBlog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/StaticBlog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/StaticBlog/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/StaticBlog/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://meesong.github.io/StaticBlog/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="MeeSong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/StaticBlog/uploads/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="MeeSong's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Windows kernel learning: 5. Process, Thread and Jobs</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-29T10:47:32+08:00">
                2017-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/StaticBlog/categories/Windows-kernel-learning/" itemprop="url" rel="index">
                    <span itemprop="name">Windows kernel learning</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从概念上来说, 进程是线程的容器, 进程提供了线程必要的地址空间, 上下文环境, 安全凭证等等..而线程是最基本的执行单位和调度单位. 作业呢? 作业可以看作是进程的容器, 使其可以对进程进行统一的管理.</p>
<p>从实际上来说, 内核就是各种各样的数据结构, 进程, 线程和作业也不例外.</p>
<a id="more"></a>
<p>每个 Windows 进程都是由一个执行体进程结构 <code>EPROCESS</code> 来表示的, 结构中包含了许多进程有关的属性和数据结构. <code>EPROCESS</code> 和相关的数据结构位域系统空间中, 不过进程环境块 <code>PEB</code> 是个例外, 它位于进程地址空间中.</p>
<p>Windows 线程是由一个执行体线程结构 <code>ETHREAD</code> 来表示的, 同样, 除了线程环境块 <code>TEB</code> 位于进程地址空间中, 其他都位于系统空间中.</p>
<p>对于每个执行了一个 Win32 程序的进程, Win32子系统进程 (Csrss) 为它维护了一个平行的结构 <code>CSR_PROCESS</code>. 同时也为每个线程维护了平行的结构 <code>CSR_THREAD</code>.</p>
<p>Windows 子系统的内核模式部分 (Win32k.sys) 有一个针对每个进程的数据结构, <code>W32PROCESS</code>. 每当一个线程第一次调用 Windows 的 USER/GDI 函数时, W32PROCESS 结构就会被创建.</p>
<img src="/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/P-T-Associated.jpg" alt="Data structures associated with processes and threads" title="Data structures associated with processes and threads">
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>我们先来看一下相关的数据结构</p>
<h3 id="进程相关结构"><a href="#进程相关结构" class="headerlink" title="进程相关结构"></a>进程相关结构</h3><figure class="highlight c"><figcaption><span>EPROCESS</span><a href="/StaticBlog/downloads/code/EPROCESS.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">EPROCESS</span>                                  // 161 <span class="title">elements</span>, 0<span class="title">x6B8</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KPROCESS</span> <span class="title">Pcb</span>;</span>                                 <span class="comment">// 进程控制块, 因为是 EPROCESS 的第一个字段, 所以 KPROCESS 和 EPROCESS 的地址是一样的</span></div><div class="line"><span class="comment">/*0x2C8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">ProcessLock</span>;</span>                     <span class="comment">// 与 KPROCESS 中的自旋锁同名, 但它们的类型不同, 保护的成员也不同. 这里的 ProcessLock 域是一个推锁 (push lock) 对象, 用于保护EPROCESS 中的数据成员</span></div><div class="line"><span class="comment">/*0x2D0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER CreateTime;                      <span class="comment">// 进程创建时间</span></div><div class="line"><span class="comment">/*0x2D8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_RUNDOWN_REF</span> <span class="title">RundownProtect</span>;</span>                <span class="comment">// 进程的停止保护锁, 当一个进程到最后被销毁时, 它要等到所有其他进程和线程已经释放了此锁, 才可以继续进行</span></div><div class="line"><span class="comment">/*0x2E0*/</span>     HANDLE       UniqueProcessId;                         <span class="comment">// 进程id</span></div><div class="line"><span class="comment">/*0x2E8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ActiveProcessLinks</span>;</span>                <span class="comment">// 活动进程链表, 表头是全局变量PsActiveProcessHead</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x2F8*/</span>         ULONG32      Flags2;</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      JobNotReallyActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      AccountingFolded : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      NewProcessReported : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ExitProcessReported : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ReportCommitChanges : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      LastReportMemory : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ForceWakeCharge : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      CrossSessionCreate : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      NeedsHandleRundown : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      RefTraceEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      DisableDynamicCode : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      EmptyJobEvaluated : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      DefaultPagePriority : <span class="number">3</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      PrimaryTokenFrozen : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ProcessVerifierTarget : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      StackRandomizationDisabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      AffinityPermanent : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      AffinityUpdateEnable : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      PropagateNode : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ExplicitAffinity : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ProcessExecutionState : <span class="number">2</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      DisallowStrippedImages : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      HighEntropyASLREnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ExtensionPointDisable : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ForceRelocateImages : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ProcessStateChangeRequest : <span class="number">2</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      ProcessStateChangeInProgress : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2F8*/</span>             ULONG32      DisallowWin32kSystemCalls : <span class="number">1</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x2FC*/</span>         ULONG32      Flags;</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      CreateReported : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      NoDebugInherit : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessExiting : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessDelete : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ControlFlowGuardEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      VmDeleted : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      OutswapEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      Outswapped : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ForkFailed : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      Wow64VaSpace4Gb : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      AddressSpaceInitialized : <span class="number">2</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      SetTimerResolution : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      BreakOnTermination : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      DeprioritizeViews : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      WriteWatch : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessInSession : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      OverrideAddressSpace : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      HasAddressSpace : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      LaunchPrefetched : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      Background : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      VmTopDown : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ImageNotifyDone : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      PdeUpdateNeeded : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      VdmAllowed : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessRundown : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessInserted : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      DefaultIoPriority : <span class="number">3</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      ProcessSelfDelete : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x2FC*/</span>             ULONG32      SetTimerResolutionLink : <span class="number">1</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x300*/</span>     UINT64       ProcessQuotaUsage[<span class="number">2</span>];                    <span class="comment">// 指一个进程的内存使用量和尖峰使用量.</span></div><div class="line"><span class="comment">/*0x310*/</span>     UINT64       ProcessQuotaPeak[<span class="number">2</span>];                     <span class="comment">// 指一个进程的尖峰使用量.</span></div><div class="line">                                                                    <span class="comment">// 这两个域是数组, 其中的元素分别对应于非换页内存池, 换页内存池和交换文件中的内存使用情况.</span></div><div class="line">                                                                    <span class="comment">// 这两个数组是在 PspChargeQuota 函数中计算的</span></div><div class="line"></div><div class="line"><span class="comment">/*0x320*/</span>     UINT64       PeakVirtualSize;                         <span class="comment">// 虚拟内存大小的尖峰值</span></div><div class="line"><span class="comment">/*0x328*/</span>     UINT64       VirtualSize;                             <span class="comment">// 进程的虚拟内存大小</span></div><div class="line"><span class="comment">/*0x330*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">SessionProcessLinks</span>;</span>               <span class="comment">// 会话进程链表, 当进程加入到一个系统会话中时, 其 SessionProcessLinks 域将作为一个节点加入到该会话的进程链表中</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x340*/</span>         VOID*        ExceptionPortData;                   <span class="comment">// 异常端口句柄, 当一个进程中的线程发生用户模式异常时,</span></div><div class="line">                                                                    <span class="comment">// 内核的异常处理例程在处理异常过程中, 将向该进程的异常端口或调试端口发送消息,</span></div><div class="line">                                                                    <span class="comment">// 从而使这些端口的接收方 (调试器或 Windows 子系统) 能够处理该异常</span></div><div class="line"><span class="comment">/*0x340*/</span>         UINT64       ExceptionPortValue;</div><div class="line"><span class="comment">/*0x340*/</span>         UINT64       ExceptionPortState : <span class="number">3</span>;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x348*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_FAST_REF</span> <span class="title">Token</span>;</span>                            <span class="comment">// 快速引用, 指向该进程的访问令牌, 用于该进程的安全访问检查</span></div><div class="line"><span class="comment">/*0x350*/</span>     UINT64       WorkingSetPage;                          <span class="comment">// 包含进程工作集的页面</span></div><div class="line"><span class="comment">/*0x358*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">AddressCreationLock</span>;</span>             <span class="comment">// 当内核代码需要对虚拟地址空间进行操作时, 它必须在 AddressCreationLock 上执行锁操作, 完成以后再解锁</span></div><div class="line"><span class="comment">/*0x360*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">PageTableCommitmentLock</span>;</span>         <span class="comment">//</span></div><div class="line"><span class="comment">/*0x368*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ETHREAD</span>* <span class="title">RotateInProgress</span>;</span></div><div class="line"><span class="comment">/*0x370*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ETHREAD</span>* <span class="title">ForkInProgress</span>;</span>                      <span class="comment">// 正在复制地址空间的那个线程, 仅当在地址空间复制过程中, 此域才会被赋值, 在其他情况下为 NULL</span></div><div class="line"><span class="comment">/*0x378*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EJOB</span>* <span class="title">CommitChargeJob</span>;</span>                        <span class="comment">//</span></div><div class="line"><span class="comment">/*0x380*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_AVL_TREE</span> <span class="title">CloneRoot</span>;</span>                       <span class="comment">// 指向一个平衡树的根, 当进程地址空间复制时, 此树被创建, 创建出来以后, 一直到进程退出的时候才被销毁. 完全是为了支持 fork 语义而引入</span></div><div class="line"><span class="comment">/*0x388*/</span>     UINT64       NumberOfPrivatePages;                    <span class="comment">// 进程私有页面的数量</span></div><div class="line"><span class="comment">/*0x390*/</span>     UINT64       NumberOfLockedPages;                     <span class="comment">// 被锁住页面的数量</span></div><div class="line"><span class="comment">/*0x398*/</span>     VOID*        Win32Process;                            <span class="comment">// Win32k 进程结构体, 仅 GUI 进程有效</span></div><div class="line"><span class="comment">/*0x3A0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EJOB</span>* <span class="title">Job</span>;</span>                                    <span class="comment">// 只有当一个进程属于一个 Job (作业) 的时候, 它才会指向一个_EJOB 对象</span></div><div class="line"><span class="comment">/*0x3A8*/</span>     VOID*        SectionObject;                           <span class="comment">// 为可执行程序映像创建的文件映射区对象</span></div><div class="line"><span class="comment">/*0x3B0*/</span>     VOID*        SectionBaseAddress;                      <span class="comment">// 映射区对象基址</span></div><div class="line"><span class="comment">/*0x3B8*/</span>     ULONG32      Cookie;                                  <span class="comment">// 存放的是一个代表该进程的随机值, 当第一次通过 NtQueryInformationProcess 函数获取此 Cookie 值的时候, 系统会生成一个随机值, 以后就用该值代表此进程</span></div><div class="line"><span class="comment">/*0x3BC*/</span>     UINT8        _PADDING0_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x3C0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PAGEFAULT_HISTORY</span>* <span class="title">WorkingSetWatch</span>;</span>           <span class="comment">// 用于监视一个进程的页面错误, 一旦启用了页面错误监视功能 (由全局变量PsWatchEnabled 开关来控制),</span></div><div class="line">                                                                    <span class="comment">// 则每次发生页面错误都会将该页面错误记录到 WorkingSetWatch 域的WatchInfo 成员数组中,</span></div><div class="line">                                                                    <span class="comment">// 直至数组满为止 (参见 PsWatchWorkingSet 函数的代码)</span></div><div class="line"><span class="comment">/*0x3C8*/</span>     VOID*        Win32WindowStation;                      <span class="comment">// 一个进程所属的窗口站的句柄. 由于句柄的值是由每个进程的句柄表来决定的,</span></div><div class="line">                                                                    <span class="comment">// 所以两个进程即使同属于一个窗口站, 它们的 Win32WindowStation 值也可能不同, 但指向的窗口站对象是相同的.</span></div><div class="line">                                                                    <span class="comment">// 窗口站是由 Windows 子系统来管理和控制的</span></div><div class="line"><span class="comment">/*0x3D0*/</span>     VOID*        InheritedFromUniqueProcessId;            <span class="comment">// 父进程id</span></div><div class="line"><span class="comment">/*0x3D8*/</span>     VOID*        LdtInformation;                          <span class="comment">// LDT 局部描述符表</span></div><div class="line"><span class="comment">/*0x3E0*/</span>     UINT64       OwnerProcessId;                          <span class="comment">//</span></div><div class="line"><span class="comment">/*0x3E8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span>* <span class="title">Peb</span>;</span>                                     <span class="comment">// 进程环境块, 位于进程地址空间的内存块, 其中包含了有关进程地址空间中的堆和系统模块等信息</span></div><div class="line"><span class="comment">/*0x3F0*/</span>     VOID*        Session;                                 <span class="comment">// 向进程所在的系统会话, 实际上它是一个指向 MM_SESSION_SPACE 的指针, 每个进程在初始创建地址空间时会加入到当前的系统会话中</span></div><div class="line"><span class="comment">/*0x3F8*/</span>     VOID*        AweInfo;                                 <span class="comment">// 指向 AWEINFO 结构的指针, 其目的是支持 AWE (Address Windowing Extension, 地址窗口扩展)</span></div><div class="line"><span class="comment">/*0x400*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EPROCESS_QUOTA_BLOCK</span>* <span class="title">QuotaBlock</span>;</span>             <span class="comment">// 配额块</span></div><div class="line">                                                                    <span class="comment">// Windows 系统中的配额块相互串起来构成了一个双链表, 每个配额块都可以被多个进程共享,                                // 所以有一个引用计数值用来说明当前有多少个进程在使用这一配额块.</span></div><div class="line">                                                                    <span class="comment">// 配额块中主要定义了非换页内存池, 换页内存池和交换文件中的内存配额限制.</span></div><div class="line">                                                                    <span class="comment">// 系统的默认配额块为 PspDefaultQuotaBlock, 所有配额块构成的双链表的表头为 PspQuotaBlockList</span></div><div class="line"><span class="comment">/*0x408*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">HANDLE_TABLE</span>* <span class="title">ObjectTable</span>;</span>                    <span class="comment">// 进程句柄表</span></div><div class="line"><span class="comment">/*0x410*/</span>     VOID*        DebugPort;                               <span class="comment">// 调试端口</span></div><div class="line"><span class="comment">/*0x418*/</span>     VOID*        Wow64Process;                            <span class="comment">// Wow64Process 指向 32 位的 PEB32 的指针. 在 Wow64 程序中, 进程有两个 PEB, 一个是 64 位的, 一个是 32 位的.</span></div><div class="line"><span class="comment">/*0x420*/</span>     VOID*        DeviceMap;                               <span class="comment">// 指向进程使用的设备表, 通常情况下同一个会话中的进程共享同样的设备表</span></div><div class="line"><span class="comment">/*0x428*/</span>     VOID*        EtwDataSource;</div><div class="line"><span class="comment">/*0x430*/</span>     UINT64       PageDirectoryPte;                        <span class="comment">// 顶级页目录页面的页表项</span></div><div class="line"><span class="comment">/*0x438*/</span>     UINT8        ImageFileName[<span class="number">15</span>];                       <span class="comment">// 进程的映像文件名, 仅包含最后一个路径分隔符之后的字符串, 不超过 16 个字符 (含最后的结尾空字符)</span></div><div class="line"><span class="comment">/*0x447*/</span>     UINT8        PriorityClass;                           <span class="comment">// 进程优先级类别, 在 WRK 中包含以下类别:</span></div><div class="line">                                                                    <span class="comment">// 0: 未知, 1: 空闲, 2: 普通, 3: 高, 4: 实时, 5: 普通之下, 6: 普通之上</span></div><div class="line"><span class="comment">/*0x448*/</span>     VOID*        SecurityPort;                            <span class="comment">// 安全端口, 指向该进程与 lsass 进程之间的跨进程通信端口</span></div><div class="line"><span class="comment">/*0x450*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SE_AUDIT_PROCESS_CREATION_INFO</span> <span class="title">SeAuditProcessCreationInfo</span>;</span> <span class="comment">// 包含了创建进程时指定的进程映像全路径名</span></div><div class="line"><span class="comment">/*0x458*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">JobLinks</span>;</span>                          <span class="comment">// 通过此节点, 一个 Job 中的所有进程构成了一个链表. 在 Windows 中, 所有的 Job 构成了一个双链表, 其链表头为全局变量 PspJobList; 每个 Job 中的进程又构成了一个双链表。</span></div><div class="line"><span class="comment">/*0x468*/</span>     VOID*        HighestUserAddress;                      <span class="comment">// 最高用户空间地址</span></div><div class="line"><span class="comment">/*0x470*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ThreadListHead</span>;</span>                    <span class="comment">// 双链表的头节点, 该链表包含了一个进程中的所有线程.</span></div><div class="line">                                                                    <span class="comment">// KPROCESS 结构中也有一个 ThreadListHead 域, 它所指的链表包含了各个子线程的 KTHREAD 结构中的 ThreadListEntry 节点</span></div><div class="line"><span class="comment">/*0x480*/</span>     ULONG32      ActiveThreads;                           <span class="comment">// 记录了当前进程有多少个活动线程. 当该值减为0 时, 所有的线程都将退出, 于是进程也退出</span></div><div class="line"><span class="comment">/*0x484*/</span>     ULONG32      ImagePathHash;</div><div class="line"><span class="comment">/*0x488*/</span>     ULONG32      DefaultHardErrorProcessing;              <span class="comment">// 指定了默认的硬件错误处理</span></div><div class="line"><span class="comment">/*0x48C*/</span>     LONG32       LastThreadExitStatus;                    <span class="comment">// 最后一个线程的退出状态</span></div><div class="line"><span class="comment">/*0x490*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_FAST_REF</span> <span class="title">PrefetchTrace</span>;</span>                    <span class="comment">// 指向与该进程关联的一个预取痕迹结构, 以支持该进程的预取</span></div><div class="line"><span class="comment">/*0x498*/</span>     VOID*        LockedPagesList;                         <span class="comment">// 一个指向LOCK_HEADER 结构的指针, 该结构包含了一个链表头, Windows 通过此链表来记录哪些页面已被锁住.</span></div><div class="line">                                                                    <span class="comment">// base\ntos\mm\iosup.c 中有一组函数用于管理此链表, 例如 MiAddMdlTracker, MiFreeMdlTracker 和 MiUpdateMdlTracker 等</span></div><div class="line"><span class="comment">/*0x4A0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER ReadOperationCount;              <span class="comment">// 记录了当前进程 NtReadFile  系统服务被调用的次数</span></div><div class="line"><span class="comment">/*0x4A8*/</span>     <span class="keyword">union</span> _LARGE_INTEGER WriteOperationCount;             <span class="comment">// 记录了当前进程 NtWriteFile  系统服务被调用的次数</span></div><div class="line"><span class="comment">/*0x4B0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER OtherOperationCount;             <span class="comment">// 记录了除读和写操作以外的其他 I/O 服务的次数</span></div><div class="line"><span class="comment">/*0x4B8*/</span>     <span class="keyword">union</span> _LARGE_INTEGER ReadTransferCount;               <span class="comment">// 记录了 I/O 读操作完成的次数</span></div><div class="line"><span class="comment">/*0x4C0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER WriteTransferCount;              <span class="comment">// 记录了 I/O 写操作完成的次数</span></div><div class="line"><span class="comment">/*0x4C8*/</span>     <span class="keyword">union</span> _LARGE_INTEGER OtherTransferCount;              <span class="comment">// 记录了 I/O 非读写操作完成的次数</span></div><div class="line"><span class="comment">/*0x4D0*/</span>     UINT64       CommitChargeLimit;                       <span class="comment">// 已提交页面数量的限制值, 如果是0 则表示没有限制. 在WRK中, 默认的限制值为0</span></div><div class="line"><span class="comment">/*0x4D8*/</span>     UINT64       CommitCharge;                            <span class="comment">// 包含了一个进程的虚拟内存已提交的页面数量</span></div><div class="line"><span class="comment">/*0x4E0*/</span>     UINT64       CommitChargePeak;                        <span class="comment">// 尖峰时刻的已提交页面数量</span></div><div class="line"><span class="comment">/*0x4E8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">MMSUPPORT</span> <span class="title">Vm</span>;</span>                                 <span class="comment">// Windows 为每个进程管理虚拟内存的重要数据结构成员</span></div><div class="line"><span class="comment">/*0x5C0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">MmProcessLinks</span>;</span>                    <span class="comment">// 所有拥有自己地址空间的进程都将加入到一个双链表中, 链表头是全局变量 MmProcessList</span></div><div class="line">                                                                    <span class="comment">// 当进程地址空间被初始创建时, MmProcessLinks 节点被加入到此全局链表中</span></div><div class="line">                                                                    <span class="comment">// 当进程地址空间被销毁时, 该节点脱离此链表.</span></div><div class="line">                                                                    <span class="comment">// 此全局链表的存在使得 Windows 系统可以方便地执行一些全局的内存管理任务。</span></div><div class="line"><span class="comment">/*0x5D0*/</span>     ULONG32      ModifiedPageCount;                       <span class="comment">// 记录了该进程中已修改页面的数量</span></div><div class="line"><span class="comment">/*0x5D4*/</span>     LONG32       ExitStatus;                              <span class="comment">// 进程的退出状态</span></div><div class="line"><span class="comment">/*0x5D8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_AVL_TREE</span> <span class="title">VadRoot</span>;</span>                         <span class="comment">// 指向一个平衡二叉树的根, 用于管理该进程的虚拟地址空间</span></div><div class="line"><span class="comment">/*0x5E0*/</span>     VOID*        VadHint;</div><div class="line"><span class="comment">/*0x5E8*/</span>     UINT64       VadCount;</div><div class="line"><span class="comment">/*0x5F0*/</span>     UINT64       VadPhysicalPages;</div><div class="line"><span class="comment">/*0x5F8*/</span>     UINT64       VadPhysicalPagesLimit;</div><div class="line"><span class="comment">/*0x600*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ALPC_PROCESS_CONTEXT</span> <span class="title">AlpcContext</span>;</span></div><div class="line"><span class="comment">/*0x620*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TimerResolutionLink</span>;</span></div><div class="line"><span class="comment">/*0x630*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PO_DIAG_STACK_RECORD</span>* <span class="title">TimerResolutionStackRecord</span>;</span></div><div class="line"><span class="comment">/*0x638*/</span>     ULONG32      RequestedTimerResolution;</div><div class="line"><span class="comment">/*0x63C*/</span>     ULONG32      SmallestTimerResolution;</div><div class="line"><span class="comment">/*0x640*/</span>     <span class="keyword">union</span> _LARGE_INTEGER ExitTime;                        <span class="comment">// 进程退出时间</span></div><div class="line"><span class="comment">/*0x648*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">INVERTED_FUNCTION_TABLE</span>* <span class="title">InvertedFunctionTable</span>;</span></div><div class="line"><span class="comment">/*0x650*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">InvertedFunctionTableLock</span>;</span></div><div class="line"><span class="comment">/*0x658*/</span>     ULONG32      ActiveThreadsHighWatermark;</div><div class="line"><span class="comment">/*0x65C*/</span>     ULONG32      LargePrivateVadCount;</div><div class="line"><span class="comment">/*0x660*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">ThreadListLock</span>;</span></div><div class="line"><span class="comment">/*0x668*/</span>     VOID*        WnfContext;</div><div class="line"><span class="comment">/*0x670*/</span>     UINT64       Spare0;</div><div class="line"><span class="comment">/*0x678*/</span>     UINT8        SignatureLevel;</div><div class="line"><span class="comment">/*0x679*/</span>     UINT8        SectionSignatureLevel;</div><div class="line"><span class="comment">/*0x67A*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PS_PROTECTION</span> <span class="title">Protection</span>;</span></div><div class="line"><span class="comment">/*0x67B*/</span>     UINT8        SpareByte20[<span class="number">1</span>];</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x67C*/</span>         ULONG32      Flags3;</div><div class="line"><span class="comment">/*0x67C*/</span>         ULONG32      Minimal : <span class="number">1</span>;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x680*/</span>     LONG32       SvmReserved;</div><div class="line"><span class="comment">/*0x684*/</span>     UINT8        _PADDING1_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x688*/</span>     VOID*        SvmReserved1;</div><div class="line"><span class="comment">/*0x690*/</span>     UINT64       SvmReserved2;</div><div class="line"><span class="comment">/*0x698*/</span>     UINT64       LastFreezeInterruptTime;</div><div class="line"><span class="comment">/*0x6A0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_DISK_COUNTERS</span>* <span class="title">DiskCounters</span>;</span></div><div class="line"><span class="comment">/*0x6A8*/</span>     VOID*        PicoContext;</div><div class="line"><span class="comment">/*0x6B0*/</span>     ULONG32      KeepAliveCounter;</div><div class="line"><span class="comment">/*0x6B4*/</span>     ULONG32      NoWakeKeepAliveCounter;</div><div class="line">          }EPROCESS, *PEPROCESS;</div></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>KPROCESS</span><a href="/StaticBlog/downloads/code/KPROCESS.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KPROCESS</span>                          // 42 <span class="title">elements</span>, 0<span class="title">x2C8</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">DISPATCHER_HEADER</span> <span class="title">Header</span>;</span>             <span class="comment">// 分发头, 使进程称为可等待对象</span></div><div class="line"><span class="comment">/*0x018*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ProfileListHead</span>;</span>           <span class="comment">// 当该进程参与性能分析 (profiling) 时, 作为一个节点加入到全局的性能分析进程列表 KiProfileListHead 中</span></div><div class="line"><span class="comment">/*0x028*/</span>     UINT64       DirectoryTableBase;              <span class="comment">// 进程的页面映射表的物理地址, 在进行进程切换的时候, 会将此值赋值给 CR3 寄存器</span></div><div class="line"><span class="comment">/*0x030*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ThreadListHead</span>;</span>            <span class="comment">// 进程中所有线程的 KTHREAD 链表</span></div><div class="line"><span class="comment">/*0x040*/</span>     ULONG32      ProcessLock;                     <span class="comment">// 用于保护 KPROCESS 中的成员</span></div><div class="line"><span class="comment">/*0x044*/</span>     ULONG32      Spare0;</div><div class="line"><span class="comment">/*0x048*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KAFFINITY_EX</span> <span class="title">Affinity</span>;</span>                <span class="comment">// 指定了该进程的线程可以在哪些处理器上运行, 其二进制表示的每一位分别对应于当前机器上的一个处理器或核</span></div><div class="line"><span class="comment">/*0x0F0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ReadyListHead</span>;</span>             <span class="comment">// 当前进程的就绪线程队列,</span></div><div class="line"><span class="comment">/*0x100*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">SwapListEntry</span>;</span>      <span class="comment">// 当一个进程要被换出内存时, 它通过此域加入到以 KiProcessOutSwapListHead 为链头的单链表中;</span></div><div class="line">                                                            <span class="comment">// 当一个进程要被换入内存时, 它通过此域加入到以 KiProcessInSwapListHead 为链头的单链表中.</span></div><div class="line"><span class="comment">/*0x108*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KAFFINITY_EX</span> <span class="title">ActiveProcessors</span>;</span>        <span class="comment">// 记录了当前进程正在哪些处理器上运行</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x1B0*/</span>             LONG32       AutoAlignment : <span class="number">1</span>;       <span class="comment">// 内存访问对齐设置, 此值会传递到线程的数据结构中</span></div><div class="line"><span class="comment">/*0x1B0*/</span>             LONG32       DisableBoost : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             LONG32       DisableQuantum : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             LONG32       AffinitySet : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             ULONG32      DeepFreeze : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             ULONG32      TimerVirtualization : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             ULONG32      CheckStackExtents : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             ULONG32      ActiveGroupsMask : <span class="number">20</span>;</div><div class="line"><span class="comment">/*0x1B0*/</span>             LONG32       ReservedFlags : <span class="number">5</span>;</div><div class="line">                  };</div><div class="line"><span class="comment">/*0x1B0*/</span>         LONG32       ProcessFlags;</div><div class="line">              };</div><div class="line">                                                            <span class="comment">// BasePriority 和 QuantumReset 都是该进程中的线程的调度参数</span></div><div class="line"><span class="comment">/*0x1B4*/</span>     CHAR         BasePriority;                    <span class="comment">// 指定一个进程中的线程的基本优先级, 所有的线程在启动时都会继承进程的 BasePriority 值</span></div><div class="line"><span class="comment">/*0x1B5*/</span>     CHAR         QuantumReset;                    <span class="comment">// 指定一个进程中线程的基本时限重置值</span></div><div class="line"><span class="comment">/*0x1B6*/</span>     UINT8        Visited;</div><div class="line"><span class="comment">/*0x1B7*/</span>     <span class="keyword">union</span> _KEXECUTE_OPTIONS Flags;                <span class="comment">// 设置一个进程的内存执行选项</span></div><div class="line"><span class="comment">/*0x1B8*/</span>     ULONG32      ThreadSeed[<span class="number">20</span>];                  <span class="comment">// 为该进程的线程选择适当的理想处理器 (IdealProcessor), 在每个线程被初始化的时候, 都指定此进程的 ThreadSeed 值作为它的理想处理器, 然后ThreadSeed 域又被设置一个新的值, 以便该进程的下一个线程使用.</span></div><div class="line">                                                            <span class="comment">// 这里的理想处理器是指在多处理器环境下, 每个线程都有一个优先选择的处理器</span></div><div class="line"><span class="comment">/*0x208*/</span>     UINT16       IdealNode[<span class="number">20</span>];                   <span class="comment">// 用于为一个进程选择优先的处理器节点, 这是在进程初始化时设定的. 这里的处理器节点是 NUMA（非一致的内存访问）结构中的概念</span></div><div class="line"><span class="comment">/*0x230*/</span>     UINT16       IdealGlobalNode;</div><div class="line"><span class="comment">/*0x232*/</span>     UINT16       Spare1;</div><div class="line"><span class="comment">/*0x234*/</span>     <span class="keyword">union</span> _KSTACK_COUNT StackCount;               <span class="comment">// 记录了当前进程中有多少个线程的栈位于内存中</span></div><div class="line"><span class="comment">/*0x238*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ProcessListEntry</span>;</span>          <span class="comment">// 用于将当前系统中所有具有活动线程的进程串成一个链表, 链表头为KiProcessListHead</span></div><div class="line"><span class="comment">/*0x248*/</span>     UINT64       CycleTime;                       <span class="comment">// 周期时间</span></div><div class="line"><span class="comment">/*0x250*/</span>     UINT64       ContextSwitches;</div><div class="line"><span class="comment">/*0x258*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KSCHEDULING_GROUP</span>* <span class="title">SchedulingGroup</span>;</span></div><div class="line"><span class="comment">/*0x260*/</span>     ULONG32      FreezeCount;</div><div class="line"><span class="comment">/*0x264*/</span>     ULONG32      KernelTime;                      <span class="comment">// 分别记录了一个进程对象在内核模式和用户模式下所花的时间. 进程的 KernelTime 和 UserTime 时间值等于其所属线程的对应 KernelTime 和UserTime 值的和.</span></div><div class="line"><span class="comment">/*0x268*/</span>     ULONG32      UserTime;                        <span class="comment">// 但是, 由于仅当一个线程结束时才更新其进程的这两个时间值, 所以, 若一个进程中尚未有任何一个线程结束, 则这两个域中的值为 0</span></div><div class="line"><span class="comment">/*0x26C*/</span>     UINT16       LdtFreeSelectorHint;</div><div class="line"><span class="comment">/*0x26E*/</span>     UINT16       LdtTableLength;                  <span class="comment">// LDT 长度</span></div><div class="line"><span class="comment">/*0x270*/</span>     <span class="keyword">union</span> _KGDTENTRY64 LdtSystemDescriptor;       <span class="comment">// LDT 系统描述符</span></div><div class="line"><span class="comment">/*0x280*/</span>     VOID*        LdtBaseAddress;                  <span class="comment">// LDT 基址</span></div><div class="line"><span class="comment">/*0x288*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">FAST_MUTEX</span> <span class="title">LdtProcessLock</span>;</span>            <span class="comment">// 进程的 LDT 锁</span></div><div class="line"><span class="comment">/*0x2C0*/</span>     VOID*        InstrumentationCallback;</div><div class="line">          }KPROCESS, *PKPROCESS;</div></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>PEB</span><a href="/StaticBlog/downloads/code/PEB.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span>                                               // 102 <span class="title">elements</span>, 0<span class="title">x388</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     UINT8        InheritedAddressSpace;</div><div class="line"><span class="comment">/*0x001*/</span>     UINT8        ReadImageFileExecOptions;</div><div class="line"><span class="comment">/*0x002*/</span>     UINT8        BeingDebugged;                                   <span class="comment">// 进程是否被调试</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x003*/</span>         UINT8        BitField;</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        ImageUsesLargePages : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        IsProtectedProcess : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        IsImageDynamicallyRelocated : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        SkipPatchingUser32Forwarders : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        IsPackagedProcess : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        IsAppContainer : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        IsProtectedProcessLight : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x003*/</span>             UINT8        SpareBits : <span class="number">1</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x004*/</span>     UINT8        Padding0[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x008*/</span>     VOID*        Mutant;</div><div class="line"><span class="comment">/*0x010*/</span>     VOID*        ImageBaseAddress;                                <span class="comment">// 进程映像基址</span></div><div class="line"><span class="comment">/*0x018*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span>* <span class="title">Ldr</span>;</span>                                    <span class="comment">// 由 PELoader 填充, 包含很多 PE 中包含的信息, 一般用来Ring3枚举加载的模块</span></div><div class="line"><span class="comment">/*0x020*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_USER_PROCESS_PARAMETERS</span>* <span class="title">ProcessParameters</span>;</span>       <span class="comment">// 指向参数块, 包含有环境变量和当前目录等..在打开文件的时候, 如果给定的只是相对路径名, 那么就会以里面的 CurrentDirectory 为起点, 形成绝对路径.</span></div><div class="line"><span class="comment">/*0x028*/</span>     VOID*        SubSystemData;</div><div class="line"><span class="comment">/*0x030*/</span>     VOID*        ProcessHeap;                                     <span class="comment">// 指向进程堆首地址, 每个程序新建时默认堆使用</span></div><div class="line"><span class="comment">/*0x038*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">FastPebLock</span>;</span>                    <span class="comment">// PEB 锁</span></div><div class="line"><span class="comment">/*0x040*/</span>     VOID*        AtlThunkSListPtr;</div><div class="line"><span class="comment">/*0x048*/</span>     VOID*        IFEOKey;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x050*/</span>         ULONG32      CrossProcessFlags;</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ProcessInJob : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ProcessInitializing : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ProcessUsingVEH : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ProcessUsingVCH : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ProcessUsingFTH : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x050*/</span>             ULONG32      ReservedBits0 : <span class="number">27</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x054*/</span>     UINT8        Padding1[<span class="number">4</span>];</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x058*/</span>         VOID*        KernelCallbackTable;                         <span class="comment">// 从内核“回调”用户空间的函数表</span></div><div class="line"><span class="comment">/*0x058*/</span>         VOID*        UserSharedInfoPtr;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x060*/</span>     ULONG32      SystemReserved[<span class="number">1</span>];</div><div class="line"><span class="comment">/*0x064*/</span>     ULONG32      AtlThunkSListPtr32;</div><div class="line"><span class="comment">/*0x068*/</span>     VOID*        ApiSetMap;</div><div class="line"><span class="comment">/*0x070*/</span>     ULONG32      TlsExpansionCounter;</div><div class="line"><span class="comment">/*0x074*/</span>     UINT8        Padding2[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x078*/</span>     VOID*        TlsBitmap;                                       <span class="comment">// 代表TLS位图</span></div><div class="line"><span class="comment">/*0x080*/</span>     ULONG32      TlsBitmapBits[<span class="number">2</span>];</div><div class="line"><span class="comment">/*0x088*/</span>     VOID*        ReadOnlySharedMemoryBase;</div><div class="line"><span class="comment">/*0x090*/</span>     VOID*        SparePvoid0;</div><div class="line"><span class="comment">/*0x098*/</span>     VOID**       ReadOnlyStaticServerData;</div><div class="line"><span class="comment">/*0x0A0*/</span>     VOID*        AnsiCodePageData;                                <span class="comment">// 这三个好像是 Nls 表</span></div><div class="line"><span class="comment">/*0x0A8*/</span>     VOID*        OemCodePageData;</div><div class="line"><span class="comment">/*0x0B0*/</span>     VOID*        UnicodeCaseTableData;</div><div class="line"><span class="comment">/*0x0B8*/</span>     ULONG32      NumberOfProcessors;                              <span class="comment">// 处理器/核心 数量</span></div><div class="line"><span class="comment">/*0x0BC*/</span>     ULONG32      NtGlobalFlag;                                    <span class="comment">// Nt 全局标记, 开启调试时, 会包含值 0x70, 具体定义在 WRK-v1.2\public\sdk\inc\ntexapi.h 的 2657 行</span></div><div class="line"><span class="comment">/*0x0C0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER CriticalSectionTimeout;</div><div class="line"><span class="comment">/*0x0C8*/</span>     UINT64       HeapSegmentReserve;                              <span class="comment">// 堆的默认保留大小</span></div><div class="line"><span class="comment">/*0x0D0*/</span>     UINT64       HeapSegmentCommit;                               <span class="comment">// 堆的默认提交大小</span></div><div class="line"><span class="comment">/*0x0D8*/</span>     UINT64       HeapDeCommitTotalFreeThreshold;                  <span class="comment">// 解除提交的总空闲块阈值</span></div><div class="line"><span class="comment">/*0x0E0*/</span>     UINT64       HeapDeCommitFreeBlockThreshold;                  <span class="comment">// 解除提交的单块阈值</span></div><div class="line"><span class="comment">/*0x0E8*/</span>     ULONG32      NumberOfHeaps;                                   <span class="comment">// 进程堆的数量</span></div><div class="line"><span class="comment">/*0x0EC*/</span>     ULONG32      MaximumNumberOfHeaps;                            <span class="comment">// ProcessHeaps 数组目前的大小</span></div><div class="line"><span class="comment">/*0x0F0*/</span>     VOID**       ProcessHeaps;                                    <span class="comment">// 一个数组, 记录了每一个堆的地址</span></div><div class="line"><span class="comment">/*0x0F8*/</span>     VOID*        GdiSharedHandleTable;</div><div class="line"><span class="comment">/*0x100*/</span>     VOID*        ProcessStarterHelper;</div><div class="line"><span class="comment">/*0x108*/</span>     ULONG32      GdiDCAttributeList;</div><div class="line"><span class="comment">/*0x10C*/</span>     UINT8        Padding3[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x110*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">RTL_CRITICAL_SECTION</span>* <span class="title">LoaderLock</span>;</span></div><div class="line"><span class="comment">/*0x118*/</span>     ULONG32      OSMajorVersion;                                  <span class="comment">// 系统主版本</span></div><div class="line"><span class="comment">/*0x11C*/</span>     ULONG32      OSMinorVersion;                                  <span class="comment">// 系统次版本</span></div><div class="line"><span class="comment">/*0x120*/</span>     UINT16       OSBuildNumber;                                   <span class="comment">// 系统构建号</span></div><div class="line"><span class="comment">/*0x122*/</span>     UINT16       OSCSDVersion;</div><div class="line"><span class="comment">/*0x124*/</span>     ULONG32      OSPlatformId;                                    <span class="comment">// 系统平台, VER_PLATFORM_WIN32_NT (2)</span></div><div class="line"><span class="comment">/*0x128*/</span>     ULONG32      ImageSubsystem;                                  <span class="comment">// 映像子系统, 在PE中有定义..例如, IMAGE_SUBSYSTEM_NATIVE(1), IMAGE_SUBSYSTEM_WINDOWS_GUI(2), IMAGE_SUBSYSTEM_WINDOWS_CUI(3)</span></div><div class="line"><span class="comment">/*0x12C*/</span>     ULONG32      ImageSubsystemMajorVersion;                      <span class="comment">// 映像子系统主版本</span></div><div class="line"><span class="comment">/*0x130*/</span>     ULONG32      ImageSubsystemMinorVersion;                      <span class="comment">// 映像子系统次版本</span></div><div class="line"><span class="comment">/*0x134*/</span>     UINT8        Padding4[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x138*/</span>     UINT64       ActiveProcessAffinityMask;                       <span class="comment">// 处理器亲和性掩码</span></div><div class="line"><span class="comment">/*0x140*/</span>     ULONG32      GdiHandleBuffer[<span class="number">60</span>];</div><div class="line"><span class="comment">/*0x230*/</span>     FUNCT_00BC_028C_PostProcessInitRoutine_DispatchAddress_FinishRoutine* PostProcessInitRoutine;</div><div class="line"><span class="comment">/*0x238*/</span>     VOID*        TlsExpansionBitmap;</div><div class="line"><span class="comment">/*0x240*/</span>     ULONG32      TlsExpansionBitmapBits[<span class="number">32</span>];</div><div class="line"><span class="comment">/*0x2C0*/</span>     ULONG32      SessionId;                                       <span class="comment">// 会话id</span></div><div class="line"><span class="comment">/*0x2C4*/</span>     UINT8        Padding5[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x2C8*/</span>     <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlags;                         <span class="comment">// 下面这4个是应用程序兼容性相关字段</span></div><div class="line"><span class="comment">/*0x2D0*/</span>     <span class="keyword">union</span> _ULARGE_INTEGER AppCompatFlagsUser;</div><div class="line"><span class="comment">/*0x2D8*/</span>     VOID*        pShimData;</div><div class="line"><span class="comment">/*0x2E0*/</span>     VOID*        AppCompatInfo;</div><div class="line"><span class="comment">/*0x2E8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">CSDVersion</span>;</span>                            <span class="comment">// 字符串, 例如 Service Pack 3</span></div><div class="line"><span class="comment">/*0x2F8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_DATA</span>* <span class="title">ActivationContextData</span>;</span></div><div class="line"><span class="comment">/*0x300*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ASSEMBLY_STORAGE_MAP</span>* <span class="title">ProcessAssemblyStorageMap</span>;</span></div><div class="line"><span class="comment">/*0x308*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_DATA</span>* <span class="title">SystemDefaultActivationContextData</span>;</span></div><div class="line"><span class="comment">/*0x310*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">ASSEMBLY_STORAGE_MAP</span>* <span class="title">SystemAssemblyStorageMap</span>;</span></div><div class="line"><span class="comment">/*0x318*/</span>     UINT64       MinimumStackCommit;</div><div class="line"><span class="comment">/*0x320*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">FLS_CALLBACK_INFO</span>* <span class="title">FlsCallback</span>;</span>                       <span class="comment">// 纤程回调?</span></div><div class="line"><span class="comment">/*0x328*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">FlsListHead</span>;</span></div><div class="line"><span class="comment">/*0x338*/</span>     VOID*        FlsBitmap;                                       <span class="comment">// 纤程位图?</span></div><div class="line"><span class="comment">/*0x340*/</span>     ULONG32      FlsBitmapBits[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x350*/</span>     ULONG32      FlsHighIndex;</div><div class="line"><span class="comment">/*0x354*/</span>     UINT8        _PADDING0_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x358*/</span>     VOID*        WerRegistrationData;</div><div class="line"><span class="comment">/*0x360*/</span>     VOID*        WerShipAssertPtr;</div><div class="line"><span class="comment">/*0x368*/</span>     VOID*        pUnused;</div><div class="line"><span class="comment">/*0x370*/</span>     VOID*        pImageHeaderHash;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x378*/</span>         ULONG32      TracingFlags;</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x378*/</span>             ULONG32      HeapTracingEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x378*/</span>             ULONG32      CritSecTracingEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x378*/</span>             ULONG32      LibLoaderTracingEnabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x378*/</span>             ULONG32      SpareTracingBits : <span class="number">29</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x37C*/</span>     UINT8        Padding6[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x380*/</span>     UINT64       CsrServerReadOnlySharedMemoryBase;</div><div class="line">          }PEB, *PPEB;</div></pre></td></tr></table></figure>
<h3 id="线程相关结构"><a href="#线程相关结构" class="headerlink" title="线程相关结构"></a>线程相关结构</h3><figure class="highlight c"><figcaption><span>ETHREAD</span><a href="/StaticBlog/downloads/code/ETHREAD.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ETHREAD</span>                                              // 100 <span class="title">elements</span>, 0<span class="title">x778</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KTHREAD</span> <span class="title">Tcb</span>;</span>                                             <span class="comment">// 线程控制块, 因为是 ETHREAD 的第一个字段, 所以 KTHREAD 和 ETHREAD 的地址是一样的</span></div><div class="line"><span class="comment">/*0x5D0*/</span>     <span class="keyword">union</span> _LARGE_INTEGER CreateTime;                                 <span class="comment">// 创建时间</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x5D8*/</span>         <span class="keyword">union</span> _LARGE_INTEGER ExitTime;                               <span class="comment">// 退出时间</span></div><div class="line"><span class="comment">/*0x5D8*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">KeyedWaitChain</span>;</span>                           <span class="comment">// 用于带键事件的等待链表</span></div><div class="line">              };</div><div class="line"><span class="comment">/*0x5E8*/</span>     VOID*        ChargeOnlySession;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x5F0*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">PostBlockList</span>;</span>                            <span class="comment">// 头节点, 该链表中的各个节点类型为PCM_POST_BLOCK, 它被用于一个线程向配置管理器登记注册表键的变化通知</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x5F0*/</span>             VOID*        ForwardLinkShadow;</div><div class="line"><span class="comment">/*0x5F8*/</span>             VOID*        StartAddress;                               <span class="comment">// 包含了线程的启动地址, 这是真正的线程启动地址</span></div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x600*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">TERMINATION_PORT</span>* <span class="title">TerminationPort</span>;</span>                   <span class="comment">// 链表头, 当一个线程退出时, 系统会通知所有已经登记过要接收其终止事件的那些端口</span></div><div class="line"><span class="comment">/*0x600*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">ETHREAD</span>* <span class="title">ReaperLink</span>;</span>                                 <span class="comment">// 单链表节点, 它仅在线程退出时使用. 当线程被终止时, 该节点将被挂到 PsReaperListHead 链表上, 所以在线程回收器 (reaper) 的工作项目 (WorkItem) 中该线程的内核栈得以收回</span></div><div class="line"><span class="comment">/*0x600*/</span>         VOID*        KeyedWaitValue;                                 <span class="comment">// 带键事件的键值</span></div><div class="line">              };</div><div class="line"><span class="comment">/*0x608*/</span>     UINT64       ActiveTimerListLock;                                <span class="comment">// ActiveTimerListHead 链表的自旋锁</span></div><div class="line"><span class="comment">/*0x610*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ActiveTimerListHead</span>;</span>                          <span class="comment">// 双链表的头, 链表中包含了当前线程的所有定时器</span></div><div class="line"><span class="comment">/*0x620*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">Cid</span>;</span>                                           <span class="comment">// 客户id, 包含 进程id 和 线程id</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x630*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KSEMAPHORE</span> <span class="title">KeyedWaitSemaphore</span>;</span>                       <span class="comment">// 信号量对象, 用于处理带键的事件</span></div><div class="line"><span class="comment">/*0x630*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KSEMAPHORE</span> <span class="title">AlpcWaitSemaphore</span>;</span>                        <span class="comment">// 信号量对象, 用于 ALPC 应答通知</span></div><div class="line">              };</div><div class="line"><span class="comment">/*0x650*/</span>     <span class="keyword">union</span> _PS_CLIENT_SECURITY_CONTEXT ClientSecurity;</div><div class="line"><span class="comment">/*0x658*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">IrpList</span>;</span>                                      <span class="comment">// 双链表头, 其中包含了当前线程所有正在处理但尚未完成的 I/O 请求 (IRP 对象)</span></div><div class="line"><span class="comment">/*0x668*/</span>     UINT64       TopLevelIrp;                                        <span class="comment">// 指向线程的顶级IRP, 它或者指向 NULL 或一个 IRP</span></div><div class="line">                                                                               <span class="comment">// 或者包含了 fsrtl.h 中定义的标记 FSRTL_FAST_IO_TOP_LEVEL_IRP 或 FSRTL_FSP_TOP_LEVEL_IRP.</span></div><div class="line">                                                                               <span class="comment">// 仅当一个线程的 I/O 调用层次中最顶级的组件是文件系统时, 才指向当前IRP</span></div><div class="line"><span class="comment">/*0x670*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">DEVICE_OBJECT</span>* <span class="title">DeviceToVerify</span>;</span>                           <span class="comment">// 指向一个待检验的设备对象, 当磁盘或 CD-ROM 设备的驱动程序发现自从上一次该线程访问该设备以来, 该设备似乎有了变化, 就会设置线程的 DeviceToVerify 域, 从而使最高层的驱动程序, 比如文件系统, 可以检测到设备的变化</span></div><div class="line"><span class="comment">/*0x678*/</span>     VOID*        Win32StartAddress;                                  <span class="comment">// Windows 子系统的启动地址</span></div><div class="line"><span class="comment">/*0x680*/</span>     VOID*        LegacyPowerObject;</div><div class="line"><span class="comment">/*0x688*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ThreadListEntry</span>;</span>                              <span class="comment">// 挂入 EPROCESS 中的线程链表</span></div><div class="line"><span class="comment">/*0x698*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_RUNDOWN_REF</span> <span class="title">RundownProtect</span>;</span>                           <span class="comment">// 线程的停止保护锁, 对于跨线程引用 TEB 结构或者挂起线程的执行等操作, 需要获得此锁才能进行, 以避免在操作过程中线程被销毁</span></div><div class="line"><span class="comment">/*0x6A0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EX_PUSH_LOCK</span> <span class="title">ThreadLock</span>;</span>                                 <span class="comment">// 用于保护线程的数据属性, 例如 PspLockThreadSecurityExclusive 和 PspLockThreadSecurityShared 利用该域来保护线程的安全属性</span></div><div class="line"><span class="comment">/*0x6A8*/</span>     ULONG32      ReadClusterSize;                                    <span class="comment">// 指明了在一次I/O操作中读取多少个页面, 用于页面交换文件和内存映射文件的读操作</span></div><div class="line"><span class="comment">/*0x6AC*/</span>     LONG32       MmLockOrdering;</div><div class="line"><span class="comment">/*0x6B0*/</span>     LONG32       CmLockOrdering;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x6B4*/</span>         ULONG32      CrossThreadFlags;                               <span class="comment">// 一些针对跨线程访问的标志位</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      Terminated : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      ThreadInserted : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      HideFromDebugger : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      ActiveImpersonationInfo : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      HardErrorsAreDisabled : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      BreakOnTermination : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      SkipCreationMsg : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      SkipTerminationMsg : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      CopyTokenOnOpen : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      ThreadIoPriority : <span class="number">3</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      ThreadPagePriority : <span class="number">3</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      RundownFail : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      UmsForceQueueTermination : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B4*/</span>             ULONG32      ReservedCrossThreadFlags : <span class="number">15</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x6B8*/</span>         ULONG32      SameThreadPassiveFlags;                         <span class="comment">// 一些只有在PASSIVE级别上才可以访问的标志位, 并且只能被该线程自身访问, 所以对这些标志位的访问不需要互锁操作</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x6B8*/</span>             ULONG32      ActiveExWorker : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B8*/</span>             ULONG32      MemoryMaker : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B8*/</span>             ULONG32      ClonedThread : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B8*/</span>             ULONG32      KeyedEventInUse : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6B8*/</span>             ULONG32      SelfTerminate : <span class="number">1</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x6BC*/</span>         ULONG32      SameThreadApcFlags;                             <span class="comment">// 一些在 APC 中断级别上被该线程自身访问的标志位, 同样地对这些标志位的访问也不需要互锁操作</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line">                      <span class="class"><span class="keyword">struct</span></span></div><div class="line">                      {</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        HardFaultBehavior : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        StartAddressInvalid : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        EtwCalloutActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        OwnsProcessWorkingSetExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        OwnsProcessWorkingSetShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        OwnsSystemCacheWorkingSetExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        OwnsSystemCacheWorkingSetShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BC*/</span>                 UINT8        OwnsSessionWorkingSetExclusive : <span class="number">1</span>;</div><div class="line">                      };</div><div class="line">                      <span class="class"><span class="keyword">struct</span></span></div><div class="line">                      {</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsSessionWorkingSetShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsProcessAddressSpaceExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsProcessAddressSpaceShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        SuppressSymbolLoad : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        Prefetching : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsVadExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsChangeControlAreaExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BD*/</span>                 UINT8        OwnsChangeControlAreaShared : <span class="number">1</span>;</div><div class="line">                      };</div><div class="line">                      <span class="class"><span class="keyword">struct</span></span></div><div class="line">                      {</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        OwnsPagedPoolWorkingSetExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        OwnsPagedPoolWorkingSetShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        OwnsSystemPtesWorkingSetExclusive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        OwnsSystemPtesWorkingSetShared : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        TrimTrigger : <span class="number">2</span>;</div><div class="line"><span class="comment">/*0x6BE*/</span>                 UINT8        Spare2 : <span class="number">2</span>;</div><div class="line">                      };</div><div class="line">                      <span class="class"><span class="keyword">struct</span></span></div><div class="line">                      {</div><div class="line"><span class="comment">/*0x6BF*/</span>                 UINT8        SystemPagePriorityActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x6BF*/</span>                 UINT8        SystemPagePriority : <span class="number">3</span>;</div><div class="line"><span class="comment">/*0x6BF*/</span>                 UINT8        Spare3 : <span class="number">4</span>;</div><div class="line">                      };</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x6C0*/</span>     UINT8        CacheManagerActive;</div><div class="line"><span class="comment">/*0x6C1*/</span>     UINT8        DisablePageFaultClustering;                         <span class="comment">// 用于控制页面交换的聚集与否</span></div><div class="line"><span class="comment">/*0x6C2*/</span>     UINT8        ActiveFaultCount;                                   <span class="comment">// 包含了正在进行之中的页面错误数量</span></div><div class="line"><span class="comment">/*0x6C3*/</span>     UINT8        LockOrderState;</div><div class="line"><span class="comment">/*0x6C4*/</span>     UINT8        _PADDING0_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x6C8*/</span>     UINT64       AlpcMessageId;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x6D0*/</span>         VOID*        AlpcMessage;</div><div class="line"><span class="comment">/*0x6D0*/</span>         ULONG32      AlpcReceiveAttributeSet;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x6D8*/</span>     LONG32       ExitStatus;                                         <span class="comment">// 退出状态码</span></div><div class="line"><span class="comment">/*0x6DC*/</span>     UINT8        _PADDING1_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x6E0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">AlpcWaitListEntry</span>;</span></div><div class="line"><span class="comment">/*0x6F0*/</span>     ULONG32      CacheManagerCount;</div><div class="line"><span class="comment">/*0x6F4*/</span>     ULONG32      IoBoostCount;</div><div class="line"><span class="comment">/*0x6F8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">BoostList</span>;</span></div><div class="line"><span class="comment">/*0x708*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">DeboostList</span>;</span></div><div class="line"><span class="comment">/*0x718*/</span>     UINT64       BoostListLock;</div><div class="line"><span class="comment">/*0x720*/</span>     UINT64       IrpListLock;                                        <span class="comment">// IrpListLock 的锁</span></div><div class="line"><span class="comment">/*0x728*/</span>     VOID*        ReservedForSynchTracking;</div><div class="line"><span class="comment">/*0x730*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">CmCallbackListHead</span>;</span></div><div class="line"><span class="comment">/*0x738*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">GUID</span>* <span class="title">ActivityId</span>;</span></div><div class="line"><span class="comment">/*0x740*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">SeLearningModeListHead</span>;</span></div><div class="line"><span class="comment">/*0x748*/</span>     VOID*        VerifierContext;</div><div class="line"><span class="comment">/*0x750*/</span>     ULONG32      KernelStackReference;</div><div class="line"><span class="comment">/*0x754*/</span>     UINT8        _PADDING2_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x758*/</span>     VOID*        AdjustedClientToken;                                <span class="comment">// 线程的 Token</span></div><div class="line"><span class="comment">/*0x760*/</span>     ULONG32      UserFsBase;                                         <span class="comment">// fs 寄存器基址?</span></div><div class="line"><span class="comment">/*0x764*/</span>     UINT8        _PADDING3_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x768*/</span>     UINT64       UserGsBase;                                         <span class="comment">// gs 寄存器基址?</span></div><div class="line"><span class="comment">/*0x770*/</span>     VOID*        PicoContext;</div><div class="line">          }ETHREAD, *PETHREAD;</div></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>KTHREAD</span><a href="/StaticBlog/downloads/code/KTHREAD.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">KTHREAD</span>                                            // 162 <span class="title">elements</span>, 0<span class="title">x5D0</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">DISPATCHER_HEADER</span> <span class="title">Header</span>;</span>                              <span class="comment">// 分发头, 使其成为可等待对象</span></div><div class="line"><span class="comment">/*0x018*/</span>     VOID*        SListFaultAddress;                                <span class="comment">// 与用户模式互锁单链表 POP 操作 (KeUserPopEntrySListFault函数) 的错误处理有关, 它记录了上一次用户模式互锁单链表 POP 操作发生页面错误的地址</span></div><div class="line"><span class="comment">/*0x020*/</span>     UINT64       QuantumTarget;</div><div class="line">                                                                             <span class="comment">// 有四个域用于内核栈的维护, 它们分别是: InitialStack, StackLimit, KernelStack 和StackBase</span></div><div class="line">                                                                             <span class="comment">// 在线程初始化时, InitialStack 和 StackBase 是相等的, 都指向原始的内核栈高地址</span></div><div class="line"><span class="comment">/*0x028*/</span>     VOID*        InitialStack;                                     <span class="comment">// 记录了原始的内核栈位置</span></div><div class="line"><span class="comment">/*0x030*/</span>     VOID*        StackLimit;                                       <span class="comment">// 记录了内核栈的低地址</span></div><div class="line"><span class="comment">/*0x038*/</span>     VOID*        StackBase;                                        <span class="comment">// 记录了当前内核栈的基地址</span></div><div class="line"><span class="comment">/*0x040*/</span>     UINT64       ThreadLock;                                       <span class="comment">// 一个自旋锁, 用于保护线程数据成员</span></div><div class="line"><span class="comment">/*0x048*/</span>     UINT64       CycleTime;                                        <span class="comment">// 周期时间</span></div><div class="line"><span class="comment">/*0x050*/</span>     ULONG32      CurrentRunTime;                                   <span class="comment">// 当前运行时间</span></div><div class="line"><span class="comment">/*0x054*/</span>     ULONG32      ExpectedRunTime;                                  <span class="comment">// 预期运行时间</span></div><div class="line"><span class="comment">/*0x058*/</span>     VOID*        KernelStack;                                      <span class="comment">// 记录了真正内核调用栈的开始位置, 由于在内核栈的顶部区域还记录了浮点处理器保存区和一个异常陷阱帧,</span></div><div class="line">                                                                             <span class="comment">// 所以 KernelStack 的位置比 InitialStack 要低一些 (KTRAP_FRAME_LENGTH + sizeof(FX_SAVE_AREA))</span></div><div class="line"><span class="comment">/*0x060*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">XSAVE_FORMAT</span>* <span class="title">StateSaveArea</span>;</span></div><div class="line"><span class="comment">/*0x068*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KSCHEDULING_GROUP</span>* <span class="title">SchedulingGroup</span>;</span></div><div class="line"><span class="comment">/*0x070*/</span>     <span class="keyword">union</span> _KWAIT_STATUS_REGISTER WaitRegister;</div><div class="line"><span class="comment">/*0x071*/</span>     UINT8        Running;</div><div class="line"><span class="comment">/*0x072*/</span>     UINT8        Alerted[<span class="number">2</span>];                                       <span class="comment">// 一个数组, 指定了该线程在每一种警告模式下是否可以被唤醒, 数组的含义是指该线程分别在内核模式和用户模式下是否可以被唤醒</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      KernelStackResident : <span class="number">1</span>;                  <span class="comment">// 该线程的内核栈是否驻留在内存中, 当内核栈被换出内存时, 该值将被置成 FALSE, 当换入内存时再置成TRUE</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ReadyTransition : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ProcessReadyQueue : <span class="number">1</span>;                    <span class="comment">// 一个线程是否在所属进程 KPROCESS 对象的 ReadyListHead 链表中, TRUE 表示在此链表中, FALSE 表示不在</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      WaitNext : <span class="number">1</span>;                             <span class="comment">// 表示这个线程马上要调用一个内核等待函数, 它的用途是在发出了一个信号 (比如释放了一个信号量对象) 以后,</span></div><div class="line">                                                                             <span class="comment">// 接下来该线程会马上调用等待函数, 所以它不必解除线程调度器锁</span></div><div class="line">                                                                             <span class="comment">// KeSetEvent 的 Wait 参数就是这个</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      SystemAffinityActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      Alertable : <span class="number">1</span>;                            <span class="comment">// 一个线程是否可以被唤醒, 当一个线程正在等待时, 如果它的 Alertable 值为 TRUE, 则它可以被唤醒</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      UserStackWalkActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ApcInterruptRequest : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      QuantumEndMigrate : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      UmsDirectedSwitchEnable : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      TimerActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      SystemThread : <span class="number">1</span>;                         <span class="comment">// 是否为系统线程</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ProcessDetachActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      CalloutActive : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ScbReadyQueue : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ApcQueueable : <span class="number">1</span>;                         <span class="comment">// 是否可以插入APC</span></div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ReservedStackInUse : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      UmsPerformingSyscall : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      ApcPendingReload : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x074*/</span>             ULONG32      Reserved : <span class="number">13</span>;</div><div class="line">                  };</div><div class="line"><span class="comment">/*0x074*/</span>         LONG32       MiscFlags;</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      AutoAlignment : <span class="number">1</span>;                        <span class="comment">// 继承自 KPROCESS, 内存访问对其设置</span></div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      DisableBoost : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      UserAffinitySet : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      AlertedByThreadId : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      QuantumDonation : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      EnableStackSwap : <span class="number">1</span>;                      <span class="comment">// 本线程的内核栈是否允许被换出</span></div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      GuiThread : <span class="number">1</span>;                            <span class="comment">// 是否 GUI 线程</span></div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      DisableQuantum : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      ChargeOnlySchedulingGroup : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      DeferPreemption : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      QueueDeferPreemption : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      ForceDeferSchedule : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      SharedReadyQueueAffinity : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      FreezeCount : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      TerminationApcRequest : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      AutoBoostEntriesExhausted : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      EtwStackTraceApcInserted : <span class="number">8</span>;</div><div class="line"><span class="comment">/*0x078*/</span>             ULONG32      ReservedFlags : <span class="number">8</span>;</div><div class="line">                  };</div><div class="line"><span class="comment">/*0x078*/</span>         LONG32       ThreadFlags;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x07C*/</span>     ULONG32      Spare0;</div><div class="line"><span class="comment">/*0x080*/</span>     ULONG32      SystemCallNumber;                                 <span class="comment">// 进行系统调用时的系统调用号</span></div><div class="line"><span class="comment">/*0x084*/</span>     ULONG32      Spare1;</div><div class="line"><span class="comment">/*0x088*/</span>     VOID*        FirstArgument;                                    <span class="comment">// 进行系统调用时的首个调用参数</span></div><div class="line"><span class="comment">/*0x090*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KTRAP_FRAME</span>* <span class="title">TrapFrame</span>;</span>                                <span class="comment">// 系统空间堆栈上的陷阱帧</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x098*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KAPC_STATE</span> <span class="title">ApcState</span>;</span>                               <span class="comment">// 指定了一个线程的APC信息, 包括APC 链表, 是否正在处理 APC 或者是否有内核 APC 或用户 APC 正在等待等信息</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x098*/</span>             UINT8        ApcStateFill[<span class="number">43</span>];</div><div class="line"><span class="comment">/*0x0C3*/</span>             CHAR         Priority;                                 <span class="comment">// 包含了该线程的优先级值, 这是指它的动态优先级, 即在执行过程中可能由于某些原因而调整过的优先级</span></div><div class="line"><span class="comment">/*0x0C4*/</span>             ULONG32      UserIdealProcessor;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x0C8*/</span>     INT64        WaitStatus;                                       <span class="comment">// 记录了等待的结果状态</span></div><div class="line"><span class="comment">/*0x0D0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KWAIT_BLOCK</span>* <span class="title">WaitBlockList</span>;</span>                            <span class="comment">// 成员指向一个以 KWAIT_BLOCK 为元素的链表, 其中的 KWAIT_BLOCK 对象指明了哪个线程在等待哪个分发器对象</span></div><div class="line">                                                                             <span class="comment">// 对于一个线程而言, WaitBlockList 域以及每个 KWAIT_BLOCK 对象中的 WaitListEntry 域构成了一个双链表, 指明了该线程正在等待哪些分发器对象</span></div><div class="line">                                                                             <span class="comment">// 而对于每个分发器对象而言, 它又有另一个KWAIT_BLOCK链表指明了哪些线程正在等待它。</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x0D8*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">WaitListEntry</span>;</span>                          <span class="comment">// 一个线程节点加入到某个链表中.</span></div><div class="line">                                                                             <span class="comment">// 例如, KPROCESS 的 ReadyListHead 域时曾提到, 在进程被换入内存过程中, 就绪状态的线程将被加入到以进程的 ReadyListHead 域为链表头的双链表中,</span></div><div class="line">                                                                             <span class="comment">// 链表中的节点即为线程的 WaitListEntry 域</span></div><div class="line"><span class="comment">/*0x0D8*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">SwapListEntry</span>;</span>                   <span class="comment">// 被用于当线程的内核栈需要被换入时, 插入到以全局变量 KiStackInSwapListHead 为链表头的单链表中.</span></div><div class="line">                                                                             <span class="comment">// 另外, 当一个线程处于 DeferredReady 状态时, 其 SwapListEntry 将被插入到某个处理器的DeferredReadyListHead 链表中 (参见 KiInsertDeferredReadyList 和KiProcessDeferredReadyList 内核函数)</span></div><div class="line">              };</div><div class="line"><span class="comment">/*0x0E8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">DISPATCHER_HEADER</span>* <span class="title">Queue</span>;</span>                              <span class="comment">// 一个队列分发器对象, 如果不为NULL, 则表示当前线程正在处理此队列对象中的项</span></div><div class="line"><span class="comment">/*0x0F0*/</span>     VOID*        Teb;                                              <span class="comment">// 线程环境块, TEB结构包含了在用户地址空间中需要访问的各种信息</span></div><div class="line"><span class="comment">/*0x0F8*/</span>     UINT64       RelativeTimerBias;</div><div class="line"><span class="comment">/*0x100*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KTIMER</span> <span class="title">Timer</span>;</span>                                          <span class="comment">// 这是附在一个线程上的定时器, 当一个线程在执行过程中需要定时器时,</span></div><div class="line">                                                                             <span class="comment">// 比如实现可超时的等待函数 (KeWaitForSingleObject 或 KeWaitForMultipleObjects), 就会用到此定时器对象.</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x140*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KWAIT_BLOCK</span> <span class="title">WaitBlock</span>[4];</span>                          <span class="comment">// 包含4 个 KWAIT_BLOCK 成员的数组, 其中第4 项专门用于可等待的定时器对象</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill4[<span class="number">20</span>];</div><div class="line"><span class="comment">/*0x154*/</span>             ULONG32      ContextSwitches;</div><div class="line"><span class="comment">/*0x158*/</span>             UINT8        _PADDING0_[<span class="number">0xA8</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill5[<span class="number">68</span>];</div><div class="line"><span class="comment">/*0x184*/</span>             UINT8        State;</div><div class="line"><span class="comment">/*0x185*/</span>             CHAR         NpxState;</div><div class="line"><span class="comment">/*0x186*/</span>             UINT8        WaitIrql;</div><div class="line"><span class="comment">/*0x187*/</span>             CHAR         WaitMode;</div><div class="line"><span class="comment">/*0x188*/</span>             UINT8        _PADDING1_[<span class="number">0x78</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill6[<span class="number">116</span>];</div><div class="line"><span class="comment">/*0x1B4*/</span>             ULONG32      WaitTime;</div><div class="line"><span class="comment">/*0x1B8*/</span>             UINT8        _PADDING2_[<span class="number">0x48</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill7[<span class="number">164</span>];</div><div class="line">                      <span class="keyword">union</span></div><div class="line">                      {</div><div class="line">                          <span class="class"><span class="keyword">struct</span></span></div><div class="line">                          {</div><div class="line"><span class="comment">/*0x1E4*/</span>                     INT16        KernelApcDisable;</div><div class="line"><span class="comment">/*0x1E6*/</span>                     INT16        SpecialApcDisable;</div><div class="line">                          };</div><div class="line"><span class="comment">/*0x1E4*/</span>                 ULONG32      CombinedApcDisable;</div><div class="line">                      };</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill8[<span class="number">40</span>];</div><div class="line"><span class="comment">/*0x168*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">KTHREAD_COUNTERS</span>* <span class="title">ThreadCounters</span>;</span></div><div class="line"><span class="comment">/*0x170*/</span>             UINT8        _PADDING3_[<span class="number">0x90</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill9[<span class="number">88</span>];</div><div class="line"><span class="comment">/*0x198*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">XSTATE_SAVE</span>* <span class="title">XStateSave</span>;</span></div><div class="line"><span class="comment">/*0x1A0*/</span>             UINT8        _PADDING4_[<span class="number">0x60</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill10[<span class="number">136</span>];</div><div class="line"><span class="comment">/*0x1C8*/</span>             VOID*        Win32Thread;                                <span class="comment">// 本线程的 W32THREAD 结构</span></div><div class="line"><span class="comment">/*0x1D0*/</span>             UINT8        _PADDING5_[<span class="number">0x30</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x140*/</span>             UINT8        WaitBlockFill11[<span class="number">176</span>];</div><div class="line"><span class="comment">/*0x1F0*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">UMS_CONTROL_BLOCK</span>* <span class="title">Ucb</span>;</span></div><div class="line"><span class="comment">/*0x1F8*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">KUMS_CONTEXT_HEADER</span>* <span class="title">Uch</span>;</span></div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x200*/</span>     VOID*        TebMappedLowVa;</div><div class="line"><span class="comment">/*0x208*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">QueueListEntry</span>;</span>                               <span class="comment">// 记录了线程在处理一个队列项时加入到队列对象的线程链表中的节点地址</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x218*/</span>         ULONG32      NextProcessor;                                  <span class="comment">// 处理器调度的选择</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x218*/</span>             ULONG32      NextProcessorNumber : <span class="number">31</span>;                   <span class="comment">// 下一个处理器号</span></div><div class="line"><span class="comment">/*0x218*/</span>             ULONG32      SharedReadyQueue : <span class="number">1</span>;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x21C*/</span>     LONG32       QueuePriority;</div><div class="line"><span class="comment">/*0x220*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KPROCESS</span>* <span class="title">Process</span>;</span>                                       <span class="comment">// 所属进程 KPROCESS</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x228*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">GROUP_AFFINITY</span> <span class="title">UserAffinity</span>;</span>                         <span class="comment">// 线程的用户亲和性, 此值初始时也继承自进程对象的Affinity 值, 以后可通过内核函数KeSetAffinityThread 改变</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x228*/</span>             UINT8        UserAffinityFill[<span class="number">10</span>];</div><div class="line"><span class="comment">/*0x232*/</span>             CHAR         PreviousMode;</div><div class="line"><span class="comment">/*0x233*/</span>             CHAR         BasePriority;</div><div class="line">                      <span class="keyword">union</span></div><div class="line">                      {</div><div class="line"><span class="comment">/*0x234*/</span>                 CHAR         PriorityDecrement;</div><div class="line">                          <span class="class"><span class="keyword">struct</span></span></div><div class="line">                          {</div><div class="line"><span class="comment">/*0x234*/</span>                     UINT8        ForegroundBoost : <span class="number">4</span>;</div><div class="line"><span class="comment">/*0x234*/</span>                     UINT8        UnusualBoost : <span class="number">4</span>;</div><div class="line">                          };</div><div class="line">                      };</div><div class="line"><span class="comment">/*0x235*/</span>             UINT8        Preempted;</div><div class="line"><span class="comment">/*0x236*/</span>             UINT8        AdjustReason;</div><div class="line"><span class="comment">/*0x237*/</span>             CHAR         AdjustIncrement;</div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x238*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">GROUP_AFFINITY</span> <span class="title">Affinity</span>;</span>                             <span class="comment">// 线程的处理器亲和性, 此值初始时继承自进程对象的Affinity 值. 为线程指定的处理器集合必须是其进程的亲和性处理器集合的子集.</span></div><div class="line">                                                                               <span class="comment">// 在线程执行过程中, 其 Affinity 值可能有两种设置:</span></div><div class="line">                                                                               <span class="comment">// 一是系统亲和性,  当该线程执行系统任务时通过 KeSetSystemAffinityThread 函数来设置</span></div><div class="line">                                                                               <span class="comment">// 二是线程本身的亲和性, 称为用户亲和性, 通过 KeRevertToUserAffinityThread 函数来设置</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x238*/</span>             UINT8        AffinityFill[<span class="number">10</span>];</div><div class="line"><span class="comment">/*0x242*/</span>             UINT8        ApcStateIndex;                              <span class="comment">// 指明了当前的 APC 状态在ApcStatePointer 域中的索引</span></div><div class="line"><span class="comment">/*0x243*/</span>             UINT8        WaitBlockCount;</div><div class="line"><span class="comment">/*0x244*/</span>             ULONG32      IdealProcessor;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x248*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KAPC_STATE</span>* <span class="title">ApcStatePointer</span>[2];</span>                          <span class="comment">// 数组元素的类型是指向 KAPC_STATE 的指针, 其两个元素分别指向线程对象的 ApcState 和SavedApcState 域, 而这两个域分别位于两个union 中</span></div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x258*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KAPC_STATE</span> <span class="title">SavedApcState</span>;</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x258*/</span>             UINT8        SavedApcStateFill[<span class="number">43</span>];</div><div class="line"><span class="comment">/*0x283*/</span>             UINT8        WaitReason;</div><div class="line"><span class="comment">/*0x284*/</span>             CHAR         SuspendCount;</div><div class="line"><span class="comment">/*0x285*/</span>             CHAR         Saturation;</div><div class="line"><span class="comment">/*0x286*/</span>             UINT16       SListFaultCount;</div><div class="line">                  };</div><div class="line">              };</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x288*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">KAPC</span> <span class="title">SchedulerApc</span>;</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill0[<span class="number">1</span>];</div><div class="line"><span class="comment">/*0x289*/</span>             UINT8        ResourceIndex;</div><div class="line"><span class="comment">/*0x28A*/</span>             UINT8        _PADDING6_[<span class="number">0x56</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill1[<span class="number">3</span>];</div><div class="line"><span class="comment">/*0x28B*/</span>             UINT8        QuantumReset;</div><div class="line"><span class="comment">/*0x28C*/</span>             UINT8        _PADDING7_[<span class="number">0x54</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill2[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x28C*/</span>             ULONG32      KernelTime;</div><div class="line"><span class="comment">/*0x290*/</span>             UINT8        _PADDING8_[<span class="number">0x50</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill3[<span class="number">64</span>];</div><div class="line"><span class="comment">/*0x2C8*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">KPRCB</span>* <span class="title">WaitPrcb</span>;</span></div><div class="line"><span class="comment">/*0x2D0*/</span>             UINT8        _PADDING9_[<span class="number">0x10</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill4[<span class="number">72</span>];</div><div class="line"><span class="comment">/*0x2D0*/</span>             VOID*        LegoData;</div><div class="line"><span class="comment">/*0x2D8*/</span>             UINT8        _PADDING10_[<span class="number">0x8</span>];</div><div class="line">                  };</div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x288*/</span>             UINT8        SchedulerApcFill5[<span class="number">83</span>];</div><div class="line"><span class="comment">/*0x2DB*/</span>             UINT8        CallbackNestingLevel;</div><div class="line"><span class="comment">/*0x2DC*/</span>             ULONG32      UserTime;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x2E0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KEVENT</span> <span class="title">SuspendEvent</span>;</span></div><div class="line"><span class="comment">/*0x2F8*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">ThreadListEntry</span>;</span>                              <span class="comment">// 代表了一个双链表上的节点, 当一个线程被创建时, 它会被加入到进程对象的ThreadListHead 链表中</span></div><div class="line"><span class="comment">/*0x308*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">MutantListHead</span>;</span>                               <span class="comment">// 一个链表头, 该链表中包含了所有属于该线程的突变体对象 (mutant, 对应于 API 中的互斥体mutex 对象)</span></div><div class="line">                                                                               <span class="comment">// 由于突变体对象是有所有权的, 一旦被某个线程等到, 则其所有权归该线程所有, 它也被连接到MutantListHead 链表中</span></div><div class="line"><span class="comment">/*0x318*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">LockEntriesFreeList</span>;</span></div><div class="line"><span class="comment">/*0x320*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">KLOCK_ENTRY</span> <span class="title">LockEntries</span>[6];</span></div><div class="line"><span class="comment">/*0x560*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">PropagateBoostsEntry</span>;</span></div><div class="line"><span class="comment">/*0x568*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">IoSelfBoostsEntry</span>;</span></div><div class="line"><span class="comment">/*0x570*/</span>     UINT8        PriorityFloorCounts[<span class="number">16</span>];</div><div class="line"><span class="comment">/*0x580*/</span>     ULONG32      PriorityFloorSummary;</div><div class="line"><span class="comment">/*0x584*/</span>     LONG32       AbCompletedIoBoostCount;</div><div class="line"><span class="comment">/*0x588*/</span>     INT16        AbReferenceCount;</div><div class="line"><span class="comment">/*0x58A*/</span>     UINT8        AbFreeEntryCount;</div><div class="line"><span class="comment">/*0x58B*/</span>     UINT8        AbWaitEntryCount;</div><div class="line"><span class="comment">/*0x58C*/</span>     ULONG32      ForegroundLossTime;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x590*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">GlobalForegroundListEntry</span>;</span></div><div class="line">                  <span class="class"><span class="keyword">struct</span></span></div><div class="line">                  {</div><div class="line"><span class="comment">/*0x590*/</span>             <span class="class"><span class="keyword">struct</span> _<span class="title">SINGLE_LIST_ENTRY</span> <span class="title">ForegroundDpcStackListEntry</span>;</span></div><div class="line"><span class="comment">/*0x598*/</span>             UINT64       InGlobalForegroundList;</div><div class="line">                  };</div><div class="line">              };</div><div class="line"><span class="comment">/*0x5A0*/</span>     INT64        ReadOperationCount;                                 <span class="comment">// 剩下这几个字段的含义同 EPROCESS 中一样</span></div><div class="line"><span class="comment">/*0x5A8*/</span>     INT64        WriteOperationCount;</div><div class="line"><span class="comment">/*0x5B0*/</span>     INT64        OtherOperationCount;</div><div class="line"><span class="comment">/*0x5B8*/</span>     INT64        ReadTransferCount;</div><div class="line"><span class="comment">/*0x5C0*/</span>     INT64        WriteTransferCount;</div><div class="line"><span class="comment">/*0x5C8*/</span>     INT64        OtherTransferCount;</div><div class="line">          }KTHREAD, *PKTHREAD;</div></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>TEB</span><a href="/StaticBlog/downloads/code/TEB.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">           <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span>                                                  // 112 <span class="title">elements</span>, 0<span class="title">x1820</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">           {</div><div class="line"><span class="comment">/*0x000*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span> <span class="title">NtTib</span>;</span>                                            <span class="comment">// 线程信息块, TIB 第一个字段是 ExceptionList, 在应用软件的异常处理起着关键作用</span></div><div class="line"><span class="comment">/*0x038*/</span>      VOID*        EnvironmentPointer;</div><div class="line"><span class="comment">/*0x040*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">ClientId</span>;</span>                                      <span class="comment">// 客户id, 包含进程 id 和线程 id</span></div><div class="line"><span class="comment">/*0x050*/</span>      VOID*        ActiveRpcHandle;                                    <span class="comment">// 活动的 RPC 句柄</span></div><div class="line"><span class="comment">/*0x058*/</span>      VOID*        ThreadLocalStoragePointer;                          <span class="comment">// TLS 数组</span></div><div class="line"><span class="comment">/*0x060*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span>* <span class="title">ProcessEnvironmentBlock</span>;</span>                            <span class="comment">// PEB 指针</span></div><div class="line"><span class="comment">/*0x068*/</span>      ULONG32      LastErrorValue;                                     <span class="comment">// LastError (GetLastError 从这里获取)</span></div><div class="line"><span class="comment">/*0x06C*/</span>      ULONG32      CountOfOwnedCriticalSections;                       <span class="comment">// 所拥有的临界区计数</span></div><div class="line"><span class="comment">/*0x070*/</span>      VOID*        CsrClientThread;</div><div class="line"><span class="comment">/*0x078*/</span>      VOID*        Win32ThreadInfo;</div><div class="line"><span class="comment">/*0x080*/</span>      ULONG32      User32Reserved[<span class="number">26</span>];</div><div class="line"><span class="comment">/*0x0E8*/</span>      ULONG32      UserReserved[<span class="number">5</span>];</div><div class="line"><span class="comment">/*0x0FC*/</span>      UINT8        _PADDING0_[<span class="number">0x4</span>];</div><div class="line"><span class="comment">/*0x100*/</span>      VOID*        WOW32Reserved;</div><div class="line"><span class="comment">/*0x108*/</span>      ULONG32      CurrentLocale;                                      <span class="comment">// 当前地区</span></div><div class="line"><span class="comment">/*0x10C*/</span>      ULONG32      FpSoftwareStatusRegister;</div><div class="line"><span class="comment">/*0x110*/</span>      VOID*        SystemReserved1[<span class="number">54</span>];</div><div class="line"><span class="comment">/*0x2C0*/</span>      LONG32       ExceptionCode;                                      <span class="comment">// 异常代码</span></div><div class="line"><span class="comment">/*0x2C4*/</span>      UINT8        Padding0[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x2C8*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">ACTIVATION_CONTEXT_STACK</span>* <span class="title">ActivationContextStackPointer</span>;</span></div><div class="line"><span class="comment">/*0x2D0*/</span>      UINT8        SpareBytes[<span class="number">24</span>];</div><div class="line"><span class="comment">/*0x2E8*/</span>      ULONG32      TxFsContext;</div><div class="line"><span class="comment">/*0x2EC*/</span>      UINT8        Padding1[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x2F0*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">GDI_TEB_BATCH</span> <span class="title">GdiTebBatch</span>;</span></div><div class="line"><span class="comment">/*0x7D8*/</span>      <span class="class"><span class="keyword">struct</span> _<span class="title">CLIENT_ID</span> <span class="title">RealClientId</span>;</span></div><div class="line"><span class="comment">/*0x7E8*/</span>      VOID*        GdiCachedProcessHandle;</div><div class="line"><span class="comment">/*0x7F0*/</span>      ULONG32      GdiClientPID;</div><div class="line"><span class="comment">/*0x7F4*/</span>      ULONG32      GdiClientTID;</div><div class="line"><span class="comment">/*0x7F8*/</span>      VOID*        GdiThreadLocalInfo;</div><div class="line"><span class="comment">/*0x800*/</span>      UINT64       Win32ClientInfo[<span class="number">62</span>];</div><div class="line"><span class="comment">/*0x9F0*/</span>      VOID*        glDispatchTable[<span class="number">233</span>];</div><div class="line"><span class="comment">/*0x1138*/</span>     UINT64       glReserved1[<span class="number">29</span>];</div><div class="line"><span class="comment">/*0x1220*/</span>     VOID*        glReserved2;</div><div class="line"><span class="comment">/*0x1228*/</span>     VOID*        glSectionInfo;</div><div class="line"><span class="comment">/*0x1230*/</span>     VOID*        glSection;</div><div class="line"><span class="comment">/*0x1238*/</span>     VOID*        glTable;</div><div class="line"><span class="comment">/*0x1240*/</span>     VOID*        glCurrentRC;</div><div class="line"><span class="comment">/*0x1248*/</span>     VOID*        glContext;</div><div class="line"><span class="comment">/*0x1250*/</span>     ULONG32      LastStatusValue;</div><div class="line"><span class="comment">/*0x1254*/</span>     UINT8        Padding2[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x1258*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">StaticUnicodeString</span>;</span></div><div class="line"><span class="comment">/*0x1268*/</span>     WCHAR        StaticUnicodeBuffer[<span class="number">261</span>];</div><div class="line"><span class="comment">/*0x1472*/</span>     UINT8        Padding3[<span class="number">6</span>];</div><div class="line"><span class="comment">/*0x1478*/</span>     VOID*        DeallocationStack;</div><div class="line"><span class="comment">/*0x1480*/</span>     VOID*        TlsSlots[<span class="number">64</span>];</div><div class="line"><span class="comment">/*0x1680*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span> <span class="title">TlsLinks</span>;</span></div><div class="line"><span class="comment">/*0x1690*/</span>     VOID*        Vdm;</div><div class="line"><span class="comment">/*0x1698*/</span>     VOID*        ReservedForNtRpc;</div><div class="line"><span class="comment">/*0x16A0*/</span>     VOID*        DbgSsReserved[<span class="number">2</span>];</div><div class="line"><span class="comment">/*0x16B0*/</span>     ULONG32      HardErrorMode;</div><div class="line"><span class="comment">/*0x16B4*/</span>     UINT8        Padding4[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x16B8*/</span>     VOID*        Instrumentation[<span class="number">11</span>];</div><div class="line"><span class="comment">/*0x1710*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">GUID</span> <span class="title">ActivityId</span>;</span></div><div class="line"><span class="comment">/*0x1720*/</span>     VOID*        SubProcessTag;</div><div class="line"><span class="comment">/*0x1728*/</span>     VOID*        PerflibData;</div><div class="line"><span class="comment">/*0x1730*/</span>     VOID*        EtwTraceData;</div><div class="line"><span class="comment">/*0x1738*/</span>     VOID*        WinSockData;                                        <span class="comment">// Winsock 数据</span></div><div class="line"><span class="comment">/*0x1740*/</span>     ULONG32      GdiBatchCount;</div><div class="line">               <span class="keyword">union</span></div><div class="line">               {</div><div class="line"><span class="comment">/*0x1744*/</span>         <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESSOR_NUMBER</span> <span class="title">CurrentIdealProcessor</span>;</span></div><div class="line"><span class="comment">/*0x1744*/</span>         ULONG32      IdealProcessorValue;</div><div class="line">                   <span class="class"><span class="keyword">struct</span></span></div><div class="line">                   {</div><div class="line"><span class="comment">/*0x1744*/</span>             UINT8        ReservedPad0;</div><div class="line"><span class="comment">/*0x1745*/</span>             UINT8        ReservedPad1;</div><div class="line"><span class="comment">/*0x1746*/</span>             UINT8        ReservedPad2;</div><div class="line"><span class="comment">/*0x1747*/</span>             UINT8        IdealProcessor;</div><div class="line">                   };</div><div class="line">               };</div><div class="line"><span class="comment">/*0x1748*/</span>     ULONG32      GuaranteedStackBytes;</div><div class="line"><span class="comment">/*0x174C*/</span>     UINT8        Padding5[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x1750*/</span>     VOID*        ReservedForPerf;</div><div class="line"><span class="comment">/*0x1758*/</span>     VOID*        ReservedForOle;</div><div class="line"><span class="comment">/*0x1760*/</span>     ULONG32      WaitingOnLoaderLock;</div><div class="line"><span class="comment">/*0x1764*/</span>     UINT8        Padding6[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x1768*/</span>     VOID*        SavedPriorityState;</div><div class="line"><span class="comment">/*0x1770*/</span>     UINT64       ReservedForCodeCoverage;</div><div class="line"><span class="comment">/*0x1778*/</span>     VOID*        ThreadPoolData;</div><div class="line"><span class="comment">/*0x1780*/</span>     VOID**       TlsExpansionSlots;</div><div class="line"><span class="comment">/*0x1788*/</span>     VOID*        DeallocationBStore;</div><div class="line"><span class="comment">/*0x1790*/</span>     VOID*        BStoreLimit;</div><div class="line"><span class="comment">/*0x1798*/</span>     ULONG32      MuiGeneration;</div><div class="line"><span class="comment">/*0x179C*/</span>     ULONG32      IsImpersonating;</div><div class="line"><span class="comment">/*0x17A0*/</span>     VOID*        NlsCache;</div><div class="line"><span class="comment">/*0x17A8*/</span>     VOID*        pShimData;</div><div class="line"><span class="comment">/*0x17B0*/</span>     UINT16       HeapVirtualAffinity;</div><div class="line"><span class="comment">/*0x17B2*/</span>     UINT16       LowFragHeapDataSlot;</div><div class="line"><span class="comment">/*0x17B4*/</span>     UINT8        Padding7[<span class="number">4</span>];</div><div class="line"><span class="comment">/*0x17B8*/</span>     VOID*        CurrentTransactionHandle;</div><div class="line"><span class="comment">/*0x17C0*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">TEB_ACTIVE_FRAME</span>* <span class="title">ActiveFrame</span>;</span></div><div class="line"><span class="comment">/*0x17C8*/</span>     VOID*        FlsData;</div><div class="line"><span class="comment">/*0x17D0*/</span>     VOID*        PreferredLanguages;</div><div class="line"><span class="comment">/*0x17D8*/</span>     VOID*        UserPrefLanguages;</div><div class="line"><span class="comment">/*0x17E0*/</span>     VOID*        MergedPrefLanguages;</div><div class="line"><span class="comment">/*0x17E8*/</span>     ULONG32      MuiImpersonation;</div><div class="line">               <span class="keyword">union</span></div><div class="line">               {</div><div class="line"><span class="comment">/*0x17EC*/</span>         UINT16       CrossTebFlags;</div><div class="line"><span class="comment">/*0x17EC*/</span>         UINT16       SpareCrossTebBits : <span class="number">16</span>;</div><div class="line">               };</div><div class="line">               <span class="keyword">union</span></div><div class="line">               {</div><div class="line"><span class="comment">/*0x17EE*/</span>         UINT16       SameTebFlags;</div><div class="line">                   <span class="class"><span class="keyword">struct</span></span></div><div class="line">                   {</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       SafeThunkCall : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       InDebugPrint : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       HasFiberData : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       SkipThreadAttach : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       WerInShipAssertCode : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       RanProcessInit : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       ClonedThread : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       SuppressDebugMsg : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       DisableUserStackWalk : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       RtlExceptionAttached : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       InitialThread : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       SessionAware : <span class="number">1</span>;</div><div class="line"><span class="comment">/*0x17EE*/</span>             UINT16       SpareSameTebBits : <span class="number">4</span>;</div><div class="line">                   };</div><div class="line">               };</div><div class="line"><span class="comment">/*0x17F0*/</span>     VOID*        TxnScopeEnterCallback;</div><div class="line"><span class="comment">/*0x17F8*/</span>     VOID*        TxnScopeExitCallback;</div><div class="line"><span class="comment">/*0x1800*/</span>     VOID*        TxnScopeContext;</div><div class="line"><span class="comment">/*0x1808*/</span>     ULONG32      LockCount;</div><div class="line"><span class="comment">/*0x180C*/</span>     ULONG32      SpareUlong0;</div><div class="line"><span class="comment">/*0x1810*/</span>     VOID*        ResourceRetValue;</div><div class="line"><span class="comment">/*0x1818*/</span>     VOID*        ReservedForWdf;</div><div class="line">           }TEB, *PTEB;</div></pre></td></tr></table></figure>
<figure class="highlight c"><figcaption><span>TIB</span><a href="/StaticBlog/downloads/code/TIB.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*Windows 8.1 x64 Checked Build*/</span></div><div class="line">          <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span>                                    // 8 <span class="title">elements</span>, 0<span class="title">x38</span> <span class="title">bytes</span> (<span class="title">sizeof</span>)</span></div><div class="line">          {</div><div class="line"><span class="comment">/*0x000*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">EXCEPTION_REGISTRATION_RECORD</span>* <span class="title">ExceptionList</span>;</span> <span class="comment">// 异常处理链</span></div><div class="line"><span class="comment">/*0x008*/</span>     VOID*        StackBase;                               <span class="comment">// 用户栈基(高)地址</span></div><div class="line"><span class="comment">/*0x010*/</span>     VOID*        StackLimit;                              <span class="comment">// 用户栈低地址(限制)</span></div><div class="line"><span class="comment">/*0x018*/</span>     VOID*        SubSystemTib;</div><div class="line">              <span class="keyword">union</span></div><div class="line">              {</div><div class="line"><span class="comment">/*0x020*/</span>         VOID*        FiberData;                           <span class="comment">// 纤程信息</span></div><div class="line"><span class="comment">/*0x020*/</span>         ULONG32      Version;</div><div class="line">              };</div><div class="line"><span class="comment">/*0x028*/</span>     VOID*        ArbitraryUserPointer;</div><div class="line"><span class="comment">/*0x030*/</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">NT_TIB</span>* <span class="title">Self</span>;</span>                                 <span class="comment">// TIB/TEB 结构起点的指针, 用于在用户层通过 FS/GS 寄存器获取指针</span></div><div class="line">          }NT_TIB, *PNT_TIB;</div></pre></td></tr></table></figure>
<h3 id="Ps-GetCurrent-Thread-Process"><a href="#Ps-GetCurrent-Thread-Process" class="headerlink" title="[Ps]GetCurrent[Thread | Process]"></a>[Ps]GetCurrent[Thread | Process]</h3><p>我们先看下内核层函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PsGetCurrentThread() ((PETHREAD)KeGetCurrentThread())</span></div><div class="line"></div><div class="line">__forceinline <span class="class"><span class="keyword">struct</span> _<span class="title">KTHREAD</span> * <span class="title">KeGetCurrentThread</span> (<span class="title">VOID</span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></div><div class="line">    <span class="keyword">return</span> (struct _KTHREAD *)__readgsqword(FIELD_OFFSET(KPCR, Prcb.CurrentThread));</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">return</span> (struct _KTHREAD *)__readfsdword(FIELD_OFFSET(KPCR, PrcbData.CurrentThread));</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 KTHREAD 是 ETHREAD 的第一个字段, 他俩的地址是一样的, 所以获取 KTHREAD 就相当于获取 ETHREAD 了.</p>
<p>我们看到 CurrentThread 是从 pcr 的 prcb 里面获取的.<br>在 x86 系统的内核层中, KPCR 结构由 fs:[0] 获取.<br>在 x64 系统的内核层中, KPCR 结构由 gs:[0] 获取.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PsGetCurrentProcess() _PsGetCurrentProcess()</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _PsGetCurrentProcess() (CONTAINING_RECORD(((KeGetCurrentThread())-&gt;ApcState.Process),EPROCESS,Pcb))</span></div></pre></td></tr></table></figure>
<p>KTHREAD 结构中, 本来就有个指向 KPROCESS 的指针 Process, 为什么还要用 ApcState 内部的 Process 呢?<br>因为要考虑到进程的 Attach. 一个进程可能会 Attach 到另一个进程上, 用以访问 Attach 进程的用户空间.<br>这样, 在常态下, PsGetCurrentProcess 返回的是当前线程所属进程的 EPROCESS 结构指针,<br>而在 Attach 状态下, 返回的是当前线程所 Attach 进程的 EPROCESS 指针.</p>
<p>接下来我们看下用户层函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function">HANDLE WINAPI <span class="title">GetCurrentProcess</span><span class="params">(VOID)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (HANDLE)NtCurrentProcess();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">HANDLE WINAPI <span class="title">GetCurrentThread</span><span class="params">(VOID)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (HANDLE)NtCurrentThread();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NtCurrentProcess()                      ((HANDLE)(LONG_PTR)-1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NtCurrentThread()                       ((HANDLE)(LONG_PTR)-2)</span></div></pre></td></tr></table></figure>
<p>我们看到, -1 是用来表示当前进程的句柄, -2 用来表示当前线程的句柄.</p>
<p>再来看下用户层的 TEB 获取</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">FORCEINLINE <span class="class"><span class="keyword">struct</span> _<span class="title">TEB</span> * <span class="title">NtCurrentTeb</span>(<span class="title">void</span>)</span></div><div class="line">&#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></div><div class="line">    <span class="keyword">return</span> (struct _TEB *)__readgsqword(FIELD_OFFSET(NT_TIB, Self));</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">return</span> (struct _TEB *)__readfsqword(FIELD_OFFSET(NT_TIB, Self));</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与内核层不同, 在用户层:<br>x86 系统上 fs:[0] 指向 TEB 结构<br>x64 系统上 gs:[0] 指向 TEB 结构</p>
<p>通过 Self 字段获取结构指针. 得到 TEB 进而可以得到 PEB</p>
<h2 id="Windows-进程的用户空间"><a href="#Windows-进程的用户空间" class="headerlink" title="Windows 进程的用户空间"></a>Windows 进程的用户空间</h2><p>在 Windows 内核中, 定义了几个全局变量来说明地址空间的范围: MmSystemRangeStart, MmUserProbeAddress 和 MmHighestUserAddress.<br>这几个变量在 WRK 中, 是由 MmInitSystem 函数初始化的. 在 Win8.1 换了地方, 而且有些定义上的变化, 我根据 Win8.1 做了小小修改.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*WRK1.2*/</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_WIN64)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MM_KSEG0_BASE  0xFFFF800000000000UI64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KSEG0_BASE 0x80000000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MM_SYSTEM_SPACE_END 0xFFFFFFFFFFFFFFFFUI64</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MI_HIGHEST_USER_ADDRESS (PVOID) (ULONG_PTR)((0x800000000000 - 0x10000 - 1)) <span class="comment">// highest user address</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MI_USER_PROBE_ADDRESS ((ULONG_PTR)(0x800000000000UI64 - 0x10000)) <span class="comment">// starting address of guard page</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MI_SYSTEM_RANGE_START (PVOID)(MM_KSEG0_BASE) <span class="comment">// start of system space</span></span></div><div class="line"></div><div class="line"><span class="comment">/*-----*/</span></div><div class="line"></div><div class="line"><span class="function">BOOLEAN <span class="title">MmInitSystem</span> <span class="params">(ULONG Phase, PLOADER_PARAMETER_BLOCK LoaderBlock)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_WIN64)</span></div><div class="line"></div><div class="line">        MmHighestUserAddress = MI_HIGHEST_USER_ADDRESS;</div><div class="line">        MmUserProbeAddress = MI_USER_PROBE_ADDRESS;</div><div class="line">        MmSystemRangeStart = MI_SYSTEM_RANGE_START;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">        MmHighestUserAddress = (PVOID)(KSEG0_BASE - <span class="number">0x10000</span> - <span class="number">1</span>);</div><div class="line">        MmUserProbeAddress = KSEG0_BASE - <span class="number">0x10000</span>;</div><div class="line">        MmSystemRangeStart = (PVOID)KSEG0_BASE;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MmSystemRangeStart 就是系统空间与用户空间的分界线.<br>MmHighestUserAddress 是应用软件在用户层可以访问的最高地址. 从 MmUserProbeAddress 开始, 就不让访问了.<br>这是因为在分界线下面留了 64KB(0x10000) 的隔离区.</p>
<h3 id="SharedUserData"><a href="#SharedUserData" class="headerlink" title="SharedUserData"></a>SharedUserData</h3><p>SharedUserData 也要说一下, 我们先看一下定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Ring 0 */</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(_WIN64)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KI_USER_SHARED_DATA 0xFFFFF78000000000UI64</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SharedUserData      ((KUSER_SHARED_DATA * const)KI_USER_SHARED_DATA)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> KI_USER_SHARED_DATA 0xFFDF0000</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SharedUserData      ((KUSER_SHARED_DATA * const) KI_USER_SHARED_DATA)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="comment">/* Ring 3 */</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> USER_SHARED_DATA    (0x7FFE0000)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SharedUserData      ((KUSER_SHARED_DATA *)USER_SHARED_DATA)</span></div></pre></td></tr></table></figure>
<p>我们看到在 Ring0 中的定义的地址按理来说应该是属于系统空间, 却同时又映射到用户空间地址, 目的是用来让用户空间的程序访问内核中的一些数据.<br>而且, 这个区间是由系统空间和所有用户空间共享, 即为所有进程所共享的.</p>
<p>我们来看一下 <code>KUSER_SHARED_DATA</code> 结构</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>: kd&gt; dtx _KUSER_SHARED_DATA <span class="number">0xFFFFF78000000000</span></div><div class="line">(*((_KUSER_SHARED_DATA *)<span class="number">0xfffff78000000000</span>))                 [Type: _KUSER_SHARED_DATA]</div><div class="line">    [+<span class="number">0x000</span>] TickCountLowDeprecated : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x004</span>] TickCountMultiplier : <span class="number">0xfa00000</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x008</span>] InterruptTime    [Type: _KSYSTEM_TIME]</div><div class="line">    [+<span class="number">0x014</span>] SystemTime       [Type: _KSYSTEM_TIME]</div><div class="line">    [+<span class="number">0x020</span>] TimeZoneBias     [Type: _KSYSTEM_TIME]</div><div class="line">    [+<span class="number">0x02c</span>] ImageNumberLow   : <span class="number">0x8664</span> [Type: unsigned short]</div><div class="line">    [+<span class="number">0x02e</span>] ImageNumberHigh  : <span class="number">0x8664</span> [Type: unsigned short]</div><div class="line">    [+<span class="number">0x030</span>] NtSystemRoot     : <span class="string">"C:\Windows"</span> [Type: wchar_t [<span class="number">260</span>]]</div><div class="line">    [+<span class="number">0x238</span>] MaxStackTraceDepth : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x23c</span>] CryptoExponent   : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x240</span>] TimeZoneId       : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x244</span>] LargePageMinimum : <span class="number">0x200000</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x248</span>] AitSamplingValue : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x24c</span>] AppCompatFlag    : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x250</span>] RNGSeedVersion   : <span class="number">0xd</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x258</span>] GlobalValidationRunlevel : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x25c</span>] TimeZoneBiasStamp : <span class="number">10</span> [Type: long]</div><div class="line">    [+<span class="number">0x260</span>] Reserved2        : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x264</span>] NtProductType    : NtProductWinNt (<span class="number">1</span>) [Type: _NT_PRODUCT_TYPE]</div><div class="line">    [+<span class="number">0x268</span>] ProductTypeIsValid : <span class="number">0x1</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x269</span>] Reserved0        [Type: unsigned char [<span class="number">1</span>]]</div><div class="line">    [+<span class="number">0x26a</span>] NativeProcessorArchitecture : <span class="number">0x9</span> [Type: unsigned short]</div><div class="line">    [+<span class="number">0x26c</span>] NtMajorVersion   : <span class="number">0x6</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x270</span>] NtMinorVersion   : <span class="number">0x3</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x274</span>] ProcessorFeatures [Type: unsigned char [<span class="number">64</span>]]</div><div class="line">    [+<span class="number">0x2b4</span>] Reserved1        : <span class="number">0x7ffeffff</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2b8</span>] Reserved3        : <span class="number">0x80000000</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2bc</span>] TimeSlip         : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2c0</span>] AlternativeArchitecture : StandardDesign (<span class="number">0</span>) [Type: _ALTERNATIVE_ARCHITECTURE_TYPE]</div><div class="line">    [+<span class="number">0x2c4</span>] AltArchitecturePad [Type: unsigned long [<span class="number">1</span>]]</div><div class="line">    [+<span class="number">0x2c8</span>] SystemExpirationDate : &#123;<span class="number">0</span>&#125; [Type: _LARGE_INTEGER]</div><div class="line">    [+<span class="number">0x2d0</span>] SuiteMask        : <span class="number">0x110</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2d4</span>] KdDebuggerEnabled : <span class="number">0x3</span> [Type: unsigned char]              <span class="comment">; &lt;-- 哈?</span></div><div class="line">    [+<span class="number">0x2d5</span>] MitigationPolicies : <span class="number">0xa</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2d5</span> ( <span class="number">1</span>: <span class="number">0</span>)] NXSupportPolicy  : <span class="number">0x2</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2d5</span> ( <span class="number">3</span>: <span class="number">2</span>)] SEHValidationPolicy : <span class="number">0x2</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2d5</span> ( <span class="number">5</span>: <span class="number">4</span>)] CurDirDevicesSkippedForDlls : <span class="number">0x0</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2d5</span> ( <span class="number">7</span>: <span class="number">6</span>)] Reserved         : <span class="number">0x0</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2d6</span>] Reserved6        [Type: unsigned char [<span class="number">2</span>]]</div><div class="line">    [+<span class="number">0x2d8</span>] ActiveConsoleId  : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2dc</span>] DismountCount    : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2e0</span>] ComPlusPackage   : <span class="number">0xffffffff</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2e4</span>] LastSystemRITEventTickCount : <span class="number">0x106ce6</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2e8</span>] NumberOfPhysicalPages : <span class="number">0x7fef1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2ec</span>] SafeBootMode     : <span class="number">0x0</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x2ed</span>] Reserved12       [Type: unsigned char [<span class="number">3</span>]]</div><div class="line">    [+<span class="number">0x2f0</span>] SharedDataFlags  : <span class="number">0xf</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">0</span>: <span class="number">0</span>)] DbgErrorPortPresent : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">1</span>: <span class="number">1</span>)] DbgElevationEnabled : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">2</span>: <span class="number">2</span>)] DbgVirtEnabled   : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">3</span>: <span class="number">3</span>)] DbgInstallerDetectEnabled : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">4</span>: <span class="number">4</span>)] DbgLkgEnabled    : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">5</span>: <span class="number">5</span>)] DbgDynProcessorEnabled : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">6</span>: <span class="number">6</span>)] DbgConsoleBrokerEnabled : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> ( <span class="number">7</span>: <span class="number">7</span>)] DbgSecureBootEnabled : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f0</span> (<span class="number">31</span>: <span class="number">8</span>)] SpareBits        : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x2f4</span>] DataFlagsPad     [Type: unsigned long [<span class="number">1</span>]]</div><div class="line">    [+<span class="number">0x2f8</span>] TestRetInstruction : <span class="number">0xc3</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x300</span>] QpcFrequency     : <span class="number">2540039</span> [Type: __int64]</div><div class="line">    [+<span class="number">0x308</span>] SystemCallPad    [Type: unsigned __int64 [<span class="number">3</span>]]</div><div class="line">    [+<span class="number">0x320</span>] TickCount        [Type: _KSYSTEM_TIME]</div><div class="line">    [+<span class="number">0x320</span>] TickCountQuad    : <span class="number">0x10635c7d</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x320</span>] ReservedTickCountOverlay [Type: unsigned long [<span class="number">3</span>]]</div><div class="line">    [+<span class="number">0x32c</span>] TickCountPad     [Type: unsigned long [<span class="number">1</span>]]</div><div class="line">    [+<span class="number">0x330</span>] Cookie           : <span class="number">0xc8d16c81</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x334</span>] CookiePad        [Type: unsigned long [<span class="number">1</span>]]</div><div class="line">    [+<span class="number">0x338</span>] ConsoleSessionForegroundProcessId : <span class="number">1444</span> [Type: __int64]</div><div class="line">    [+<span class="number">0x340</span>] TimeUpdateLock   : <span class="number">0x49ae902</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x348</span>] BaselineSystemTimeQpc : <span class="number">0x9f94d50871a</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x350</span>] BaselineInterruptTimeQpc : <span class="number">0x9f94d50871a</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x358</span>] QpcSystemTimeIncrement : <span class="number">0xd35cfe4f14ff7eb6</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x360</span>] QpcInterruptTimeIncrement : <span class="number">0xd35cfe4f14ff7eb6</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x368</span>] QpcSystemTimeIncrement32 : <span class="number">0xd35cfe4f</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x36c</span>] QpcInterruptTimeIncrement32 : <span class="number">0xd35cfe4f</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x370</span>] QpcSystemTimeIncrementShift : <span class="number">0x15</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x371</span>] QpcInterruptTimeIncrementShift : <span class="number">0x15</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x372</span>] Reserved8        [Type: unsigned char [<span class="number">14</span>]]</div><div class="line">    [+<span class="number">0x380</span>] UserModeGlobalLogger [Type: unsigned short [<span class="number">16</span>]]</div><div class="line">    [+<span class="number">0x3a0</span>] ImageFileExecutionOptions : <span class="number">0x0</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x3a4</span>] LangGenerationCount : <span class="number">0x1</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x3a8</span>] Reserved4        : <span class="number">0x0</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x3b0</span>] InterruptTimeBias : <span class="number">0x27079e3b9800</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x3b8</span>] QpcBias          : <span class="number">0x27a78d780ed587</span> [Type: unsigned __int64]</div><div class="line">    [+<span class="number">0x3c0</span>] ActiveProcessorCount : <span class="number">0x2</span> [Type: unsigned long]</div><div class="line">    [+<span class="number">0x3c4</span>] ActiveGroupCount : <span class="number">0x1</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x3c5</span>] Reserved9        : <span class="number">0x0</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x3c6</span>] QpcData          : <span class="number">0xa01</span> [Type: unsigned short]</div><div class="line">    [+<span class="number">0x3c6</span>] QpcBypassEnabled : <span class="number">0x1</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x3c7</span>] QpcShift         : <span class="number">0xa</span> [Type: unsigned char]</div><div class="line">    [+<span class="number">0x3c8</span>] TimeZoneBiasEffectiveStart : &#123;<span class="number">131406845483478733</span>&#125; [Type: _LARGE_INTEGER]</div><div class="line">    [+<span class="number">0x3d0</span>] TimeZoneBiasEffectiveEnd : &#123;<span class="number">131592096000000000</span>&#125; [Type: _LARGE_INTEGER]</div><div class="line">    [+<span class="number">0x3d8</span>] XState           [Type: _XSTATE_CONFIGURATION]</div></pre></td></tr></table></figure>
<p>我们来看一个用到这个结构的栗子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">DWORD WINAPI <span class="title">GetTickCount</span><span class="params">(VOID)</span></span></div><div class="line">&#123;</div><div class="line">    ULARGE_INTEGER TickCount;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></div><div class="line">    TickCount.QuadPart = *((<span class="keyword">volatile</span> ULONG64*)&amp;SharedUserData-&gt;TickCount);</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">while</span> (TRUE)</div><div class="line">    &#123;</div><div class="line">        TickCount.HighPart = (ULONG)SharedUserData-&gt;TickCount.High1Time;</div><div class="line">        TickCount.LowPart = SharedUserData-&gt;TickCount.LowPart;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (TickCount.HighPart == (ULONG)SharedUserData-&gt;TickCount.High2Time)</div><div class="line">            <span class="keyword">break</span>;</div><div class="line"></div><div class="line">        YieldProcessor();</div><div class="line">    &#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> (ULONG)((UInt32x32To64(TickCount.LowPart,</div><div class="line">                                  SharedUserData-&gt;TickCountMultiplier) &gt;&gt; <span class="number">24</span>) +</div><div class="line">                    UInt32x32To64((TickCount.HighPart &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFF</span>,</div><div class="line">                                  SharedUserData-&gt;TickCountMultiplier));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用户空间的这个函数需要通过 SharedUserData 的 Tick 时钟计数.</p>
<h2 id="CreateProcess"><a href="#CreateProcess" class="headerlink" title="CreateProcess"></a>CreateProcess</h2><p>接下来我们就要看一些 CreateProcess 具体是怎么做的, 对比 Win8.1 发现变化还是蛮大的.. 所以只能祭出逆向大法了..</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* CreateProcessW/A() 都是对 CreateProcessInternalW() 的包装, 所以直接逆向 CreateProcessInternalW() */</span></div><div class="line"></div><div class="line"><span class="comment">/* CreateProcessW/A() -&gt; CreateProcessInternalW() */</span></div><div class="line"></div><div class="line"><span class="function">BOOL WINAPI <span class="title">CreateProcessInternalW</span><span class="params">(</span></span></div><div class="line">    HANDLE aToken, </div><div class="line">    LPCWSTR aApplicationName, </div><div class="line">    LPWSTR aCommandLine, </div><div class="line">    LPSECURITY_ATTRIBUTES aProcessAttributes, </div><div class="line">    LPSECURITY_ATTRIBUTES aThreadAttributes, </div><div class="line">    BOOL aInheritHandles, </div><div class="line">    DWORD aCreationFlags, </div><div class="line">    LPVOID aEnvironment, </div><div class="line">    LPCWSTR aCurrentDirectory, </div><div class="line">    LPSTARTUPINFOW aStartupInfo, </div><div class="line">    LPPROCESS_INFORMATION aProcessInformation)</div><div class="line">&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="CreateThread"><a href="#CreateThread" class="headerlink" title="CreateThread"></a>CreateThread</h2><p>占坑</p>
<h2 id="APC-Asynchronous-Procedure-Calls"><a href="#APC-Asynchronous-Procedure-Calls" class="headerlink" title="APC, Asynchronous Procedure Calls"></a>APC, Asynchronous Procedure Calls</h2><p>内容比较多, 所以另开一篇文章单独介绍 </p>
<a href="/StaticBlog/2017/Windows-kernel-learning/6-APC-Asynchronous-Procedure-Calls/" title="Windows kernel learning: 6. APC, Asynchronous Procedure Calls">Windows kernel learning: 6. APC, Asynchronous Procedure Calls</a>
<hr>
<h2 id="未完待续…"><a href="#未完待续…" class="headerlink" title="未完待续…"></a>未完待续…</h2>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      MeeSong
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/" title="Windows kernel learning: 5. Process, Thread and Jobs">https://meesong.github.io/StaticBlog/2017/Windows-kernel-learning/5-Process-and-Thread/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>如果喜欢, 请给我加个🍗~</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/StaticBlog/uploads/wechat.jpg" alt="MeeSong WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/StaticBlog/uploads/alipay.jpg" alt="MeeSong Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/StaticBlog/tags/Windows/" rel="tag"># Windows</a>
          
            <a href="/StaticBlog/tags/Kernel/" rel="tag"># Kernel</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/StaticBlog/2017/Windows-kernel-learning/4-Object-Management/" rel="next" title="Windows kernel learning: 4. Object Management">
                <i class="fa fa-chevron-left"></i> Windows kernel learning: 4. Object Management
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/StaticBlog/2017/Windows-kernel-learning/6-APC-Asynchronous-Procedure-Calls/" rel="prev" title="Windows kernel learning: 6. APC, Asynchronous Procedure Calls">
                Windows kernel learning: 6. APC, Asynchronous Procedure Calls <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div onclick="showGitment()" id="gitment_title" class="gitment_title">显示 Gitment 评论</div>
      <div id="container" style="display:none"></div>
      <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
      <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
      <script>
      const myTheme = {
        render(state, instance) {
          const container = document.createElement('div');
          container.lang = "en-US";
          container.className = 'gitment-container gitment-root-container';
          container.appendChild(instance.renderHeader(state, instance));
          container.appendChild(instance.renderEditor(state, instance));
          container.appendChild(instance.renderComments(state, instance));
          container.appendChild(instance.renderFooter(state, instance));
          return container;
        }
      }

      function showGitment() {
        $("#gitment_title").attr("style", "display:none");
        $("#container").attr("style", "").addClass("gitment_container");
        var gitment = new Gitment({
          id: window.location.pathname,
          theme: myTheme,
          owner: 'MeeSong',
          repo: 'BlogComments',
          oauth: {
            client_id: 'ebc04c32e0a0c7e77aa6',
            client_secret: 'b5840ad7487a199656353a050223a77be4d39f3c'
          }
        });
        gitment.render('container');
      }
      </script>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/StaticBlog/uploads/avatar.jpg"
               alt="MeeSong" />
          <p class="site-author-name" itemprop="name">MeeSong</p>
           
              <p class="site-description motion-element" itemprop="description">生活就是不断地调试~</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/StaticBlog/archives">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/StaticBlog/categories/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/StaticBlog/tags/index.html">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/StaticBlog/rss2.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MeeSong" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github-alt"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/MeesongKwok" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/2438280555" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程相关结构"><span class="nav-number">1.1.</span> <span class="nav-text">进程相关结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程相关结构"><span class="nav-number">1.2.</span> <span class="nav-text">线程相关结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ps-GetCurrent-Thread-Process"><span class="nav-number">1.3.</span> <span class="nav-text">[Ps]GetCurrent[Thread | Process]</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows-进程的用户空间"><span class="nav-number">2.</span> <span class="nav-text">Windows 进程的用户空间</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SharedUserData"><span class="nav-number">2.1.</span> <span class="nav-text">SharedUserData</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CreateProcess"><span class="nav-number">3.</span> <span class="nav-text">CreateProcess</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CreateThread"><span class="nav-number">4.</span> <span class="nav-text">CreateThread</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#APC-Asynchronous-Procedure-Calls"><span class="nav-number">5.</span> <span class="nav-text">APC, Asynchronous Procedure Calls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#未完待续…"><span class="nav-number">6.</span> <span class="nav-text">未完待续…</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">MeeSong</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/StaticBlog/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/StaticBlog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/StaticBlog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/StaticBlog/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/StaticBlog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/StaticBlog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/StaticBlog/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/StaticBlog/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/StaticBlog/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/StaticBlog/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/StaticBlog/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/StaticBlog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  <script type="text/javascript" src="/StaticBlog/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/StaticBlog/js/src/scroll-cookie.js?v=5.1.1"></script>


  

</body>
</html>
